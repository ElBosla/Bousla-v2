<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØµÙ„Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&amp;family=Manrope:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="icon" href="../images/logo.jpg" type="image/jpeg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (localStorage.getItem('color-theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
        }
    </script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13b6ec",
                        "primary-dark": "#0e8cb5",
                        "background-light": "#f6f8f8",
                        "background-dark": "#101d22",
                        "secondary": "#263238",
                    },
                    fontFamily: {
                        "display": ["Almarai", "sans-serif"],
                        "body": ["Almarai", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Almarai', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #13b6ec;
            border-radius: 10px;
        }

        /* Sidebar Styles */
        .sidebar {
            transition: all 0.3s ease;
        }

        .sidebar-item.active {
            background-color: #13b6ec1a;
            color: #13b6ec;
            border-inline-end: 4px solid #13b6ec;
        }

        .sidebar-item {
            border-inline-end: 4px solid transparent;
        }

        /* Section Visibility */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }


        /* Dark Mode Transitions */
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .dark {
            color-scheme: dark;
        }

        .dark body {
            background-color: #0f171a;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #1a2428;
            border-color: #2d373c;
        }

        .dark .text-secondary {
            color: #f1f5f9;
        }

        .dark .text-gray-600 {
            color: #94a3b8;
        }

        .dark .bg-gray-50 {
            background-color: #151e22;
        }

        .dark .border-gray-100 {
            border-color: #2d373c;
        }

        .dark nav {
            background-color: rgba(26, 36, 40, 0.9);
            border-bottom-color: #2d373c;
        }

        .dark input,
        .dark select,
        .dark textarea {
            background-color: #151e22;
            border-color: #2d373c;
            color: white;
        }

        /* Platform Buttons */
        .platform-btn.active[data-platform="facebook"] {
            background: #1877f2 !important;
            color: white !important;
            border-color: #1877f2 !important;
        }

        .platform-btn.active[data-platform="instagram"] {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%) !important;
            color: white !important;
            border-color: transparent !important;
        }

        .platform-btn.active[data-platform="linkedin"] {
            background: #0077b5 !important;
            color: white !important;
            border-color: #0077b5 !important;
        }

        .platform-btn.active[data-platform="whatsapp"] {
            background: #25d366 !important;
            color: white !important;
            border-color: #25d366 !important;
        }

        .platform-btn.active i {
            color: white !important;
        }

        /* Calendar Task Dot */
        .task-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            display: inline-block;
        }

        .task-dot.done {
            background: #10b981;
        }

        .task-dot.pending {
            background: #f59e0b;
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 280px;
                height: 100vh;
                background: white;
                z-index: 100;
                flex-direction: column;
                border-left: 1px solid #eee;
                padding: 20px 0;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                z-index: 90;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .sidebar-item {
                flex: none;
                flex-direction: row;
                justify-content: flex-start;
                gap: 12px;
                border: none;
                border-left: 4px solid transparent;
                border-radius: 0 !important;
                padding: 14px 24px !important;
            }

            .sidebar-item.active {
                border-left: 4px solid #13b6ec;
                background: rgba(19, 182, 236, 0.05);
            }

            .sidebar-item span:last-child {
                font-size: 14px;
            }

            .main-content {
                padding-bottom: 20px;
                margin-right: 0 !important;
            }

            /* Responsive Table Card Layout */
            #table-container table,
            #table-container thead,
            #table-container tbody,
            #table-container th,
            #table-container td,
            #table-container tr {
                display: block;
            }

            #table-container thead {
                display: none;
            }

            #table-container tr {
                margin-bottom: 1.5rem;
                padding: 1.25rem;
                border-radius: 1.5rem;
                background: white;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            }

            .dark #table-container tr {
                background: #1a2428;
                border: 1px solid #2d373c;
            }

            #table-container td {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f1f5f9;
                display: flex;
                justify-content: space-between;
                align-items: center;
                white-space: normal;
            }

            .dark #table-container td {
                border-bottom-color: #2d373c;
            }

            #table-container td:last-child {
                border-bottom: none;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Add data labels for table cells */
            #table-container td::before {
                content: attr(data-label);
                font-weight: 800;
                color: #94a3b8;
                font-size: 10px;
                text-transform: uppercase;
                margin-left: 1rem;
            }

            /* Chat Mobile Optimization */
            @media (max-width: 1024px) {
                #section-messages .flex-col.lg\:flex-row {
                    height: calc(100dvh - 145px) !important;
                    /* Total viewport minus top nav and bottom sidebar */
                    gap: 0 !important;
                    margin: -1rem !important;
                    /* Counter act main-content padding if any */
                }

                .chat-sidebar-mobile {
                    position: fixed;
                    top: 0;
                    right: -100%;
                    bottom: 70px;
                    /* Above mobile bottom nav */
                    width: 280px;
                    z-index: 150;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    border-radius: 0 !important;
                    background: white;
                }

                .dark .chat-sidebar-mobile {
                    background: #1a2428;
                }

                .chat-sidebar-mobile.open {
                    right: 0;
                    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.2);
                }

                .chat-overlay {
                    display: none;
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(4px);
                    z-index: 140;
                }

                .chat-overlay.show {
                    display: block;
                }

                #activeChatHeader {
                    padding: 0.75rem 1rem !important;
                }

                #chatMessages {
                    padding: 1rem !important;
                }
            }
        }

        /* Hide body until auth check completes */
        body {
            visibility: hidden;
        }
    </style>
    <script>
        // Immediate Auth Check
        if (sessionStorage.getItem('admin_auth') !== 'true') {
            window.location.replace('index.html');
        } else {
            document.documentElement.style.visibility = 'visible';
            window.addEventListener('DOMContentLoaded', () => {
                document.body.style.visibility = 'visible';
            });
        }
    </script>
</head>

<body class="bg-background-light text-secondary antialiased overflow-x-hidden min-h-screen">

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="flex flex-col lg:flex-row">
        <!-- Sidebar -->
        <aside
            class="sidebar lg:w-72 lg:h-screen lg:sticky lg:top-0 bg-white dark:bg-[#1a2428] border-l border-gray-100 dark:border-gray-800 flex flex-col z-[100] overflow-y-auto">
            <div class="flex lg:flex-none items-center justify-between mb-6 lg:mb-10 px-6 py-8">
                <div class="flex items-center gap-3">
                    <img src="../images/logo.jpg" alt="Ù„ÙˆØ¬Ùˆ Ø¨ÙˆØµÙ„Ø©" class="size-12 rounded-2xl object-cover shadow-lg" />
                    <div>
                        <span
                            class="text-2xl font-black tracking-tight text-secondary dark:text-white block leading-none">Ø¨ÙˆØµÙ„Ø©</span>
                        <span
                            class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1 block">DashBoard</span>
                    </div>
                </div>
                <button onclick="toggleSidebar()"
                    class="lg:hidden size-10 bg-gray-50 dark:bg-gray-900 rounded-xl flex items-center justify-center text-gray-400">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="flex flex-col gap-1 lg:gap-2 flex-1 px-4 lg:px-0">
                <button onclick="switchSection('applicants')" id="nav-applicants"
                    class="sidebar-item active flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full">
                    <span class="material-symbols-outlined">groups</span>
                    <span>Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                </button>
                <button onclick="switchSection('consultations')" id="nav-consultations"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full admin-only">
                    <span class="material-symbols-outlined">event_available</span>
                    <span>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</span>
                </button>
                <button onclick="switchSection('stats')" id="nav-stats"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full admin-only">
                    <span class="material-symbols-outlined">query_stats</span>
                    <span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span>
                </button>
                <button onclick="switchSection('messages')" id="nav-messages"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full admin-only">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                </button>
                <button onclick="switchSection('teachers')" id="nav-teachers"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full admin-only">
                    <span class="material-symbols-outlined">record_voice_over</span>
                    <span>Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</span>
                </button>
                <button onclick="switchSection('users')" id="nav-users"
                    class="sidebar-item flex items-center gap-3 px-4 py-3.5 rounded-xl font-bold transition-all w-full admin-only">
                    <span class="material-symbols-outlined">shield_person</span>
                    <span>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
            </div>

            <div class="flex flex-col gap-2 mt-auto p-6 border-t border-gray-50 dark:border-gray-800">
                <button id="darkModeToggleSidebar"
                    class="flex items-center gap-3 px-4 py-3.5 text-gray-500 hover:text-primary hover:bg-primary/5 rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined theme-icon">dark_mode</span>
                    <span>Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
                </button>
                <button onclick="logout()"
                    class="flex items-center gap-3 px-4 py-3.5 text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-1 min-h-screen bg-gray-50/50 dark:bg-gray-900/50 transition-all">
            <!-- Top Navbar (Mobile) -->
            <nav
                class="lg:hidden sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-gray-100 dark:border-gray-800 flex justify-between items-center px-6 h-20 shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()"
                        class="size-10 bg-gray-50 dark:bg-gray-800 rounded-xl flex items-center justify-center text-secondary dark:text-white mr-2">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <img src="../images/logo.jpg" alt="Ù„ÙˆØ¬Ùˆ Ø¨ÙˆØµÙ„Ø©" class="size-10 rounded-xl object-cover" />
                    <span class="text-xl font-black text-secondary dark:text-white">Ø¨ÙˆØµÙ„Ø©</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="logout()"
                        class="size-10 bg-gray-50 dark:bg-gray-800 rounded-xl flex items-center justify-center text-gray-400">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
            </nav>

            <div class="p-4 lg:p-10">

                <!-- SECTION: APPLICANTS -->
                <section id="section-applicants" class="admin-section active">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <!-- Right Side: Title & Subtitle -->
                        <div class="order-2 lg:order-1 text-right">
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</h1>
                            <p class="text-gray-400 font-bold flex items-center justify-end gap-2 text-sm">
                                <span>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ Ø§Ù„Ù…Ø³Ø§Ø±Ø§ØªØŒ ÙˆØ§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù…</span>
                                <span class="bg-gray-200 dark:bg-gray-700 w-1.5 h-1.5 rounded-full"></span>
                                <span id="currentDate" class="text-primary font-black">12 ÙŠÙ†Ø§ÙŠØ± 2026</span>
                            </p>
                        </div>

                        <!-- Left Side: Action Buttons -->
                        <div class="order-1 lg:order-2 flex items-center gap-3">
                            <button id="deleteAllBtn"
                                class="flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-500 text-sm font-bold py-3 px-6 rounded-2xl transition-all admin-only border border-red-100 dark:border-red-900/30 dark:bg-red-900/10 dark:text-red-400">
                                <span class="material-symbols-outlined text-lg">delete_sweep</span>
                                <span>Ø­Ø°Ù Ø§Ù„ÙƒÙ„</span>
                            </button>
                            <button id="exportBtn"
                                class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-3 px-6 rounded-2xl transition-all shadow-lg shadow-green-500/20">
                                <span class="material-symbols-outlined text-lg">description</span>
                                <!-- Changed icon to description/excel like -->
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <!-- Total Applicants -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†
                                </p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="applicantCount">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-blue-50 dark:bg-blue-900/20 rounded-[1.5rem] flex items-center justify-center text-blue-500">
                                <span class="material-symbols-outlined text-3xl">groups</span>
                            </div>
                        </div>

                        <!-- Active Students -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙŠÙ†</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="activeCountStats">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-green-50 dark:bg-green-900/20 rounded-[1.5rem] flex items-center justify-center text-green-500">
                                <span class="material-symbols-outlined text-3xl">check_circle</span>
                            </div>
                        </div>

                        <!-- Expiring Soon -->
                        <div
                            class="bg-white dark:bg-[#1a2428] p-6 lg:p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm flex items-center justify-between">
                            <div class="text-right">
                                <p class="text-gray-400 text-xs font-bold mb-2 uppercase tracking-wide">ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
                                <h3 class="text-4xl font-black text-secondary dark:text-white" id="expiringCountStats">0
                                </h3>
                            </div>
                            <div
                                class="size-16 bg-orange-50 dark:bg-orange-900/20 rounded-[1.5rem] flex items-center justify-center text-orange-500">
                                <span class="material-symbols-outlined text-3xl">notifications_active</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters & Search Bar -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-4 lg:p-4 border border-gray-100 dark:border-gray-800 shadow-sm mb-8">
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <!-- Search (Right in RTL) -->
                            <div class="relative w-full lg:w-auto lg:flex-[1.5]">
                                <span
                                    class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø£Ùˆ..."
                                    class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-sm transition-all focus:bg-white dark:focus:bg-[#1a2428]">
                            </div>

                            <!-- Filters Dropdowns -->
                            <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto flex-[2]">
                                <select id="specializationFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ®ØµØµØ§Øª ğŸ”½</option>
                                </select>
                                <select id="planFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª ğŸ”½</option>
                                </select>
                                <select id="paymentFilter"
                                    class="w-full h-14 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-bold text-gray-500 px-6 cursor-pointer text-xs appearance-none text-right"
                                    style="background-image: none;">
                                    <option value="">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ ğŸ”½</option>
                                    <option value="paid">ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</option>
                                    <option value="unpaid">Ù„Ù… ÙŠØ¯ÙØ¹ âŒ</option>
                                </select>
                            </div>

                            <!-- Reset Button (Left in RTL) -->
                            <button id="resetSearchBtn"
                                class="w-full lg:w-auto h-14 px-8 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 text-gray-500 font-bold rounded-2xl transition-all text-xs whitespace-nowrap">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden p-1">
                        <div id="loading-data" class="p-24 text-center">
                            <div
                                class="inline-block size-14 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-6">
                            </div>
                            <p class="text-gray-400 font-black tracking-widest uppercase text-xs">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                            </p>
                        </div>
                        <div id="error-message" class="hidden p-8 bg-red-50 text-red-600 text-center font-bold"></div>
                        <div class="overflow-x-auto" id="table-container"></div>
                    </div>
                </section>

                <!-- SECTION: CONSULTATIONS -->
                <section id="section-consultations" class="admin-section">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª
                                Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h1>
                            <p class="text-gray-400 font-bold flex items-center gap-2">
                                <span>Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</span>
                                <span class="bg-gray-200 dark:bg-gray-700 w-1.5 h-1.5 rounded-full"></span>
                                <span
                                    class="consultation-count-badge bg-primary/10 text-primary px-3 py-1 rounded-lg text-xs font-black">0
                                    Ø·Ù„Ø¨</span>
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="exportConsultationsBtn"
                                class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-3 px-6 rounded-2xl transition-all shadow-lg shadow-purple-500/20">
                                <span class="material-symbols-outlined text-sm">download</span>
                                <span>ØªØµØ¯ÙŠØ± Excel</span>
                            </button>
                        </div>
                    </div>

                    <!-- Consultation Filters -->
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 border border-gray-100 dark:border-gray-800 shadow-sm mb-10">
                        <div class="relative flex-1">
                            <span
                                class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                            <input type="text" id="consultationSearchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©..."
                                class="w-full h-14 pr-12 bg-gray-50 dark:bg-[#151e22] border-none rounded-2xl focus:ring-2 focus:ring-primary font-medium transition-all">
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto custom-scrollbar" id="consultation-table-container">
                            <div class="p-20 text-center text-gray-400 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª...</div>
                        </div>
                    </div>
                </section>

                <!-- SECTION: MESSAGES (CHAT) -->
                <section id="section-messages" class="admin-section">
                    <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-180px)] lg:h-[calc(100vh-180px)]">
                        <div id="chatOverlay" class="chat-overlay lg:hidden" onclick="toggleChatSidebar()"></div>
                        <!-- Chats List -->
                        <div id="chatSidebar"
                            class="lg:w-80 bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 flex flex-col overflow-hidden shadow-sm chat-sidebar-mobile">
                            <div class="p-6 border-b border-gray-50 dark:border-gray-800">
                                <h2 class="text-xl font-black text-secondary dark:text-white">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
                                <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-widest">Ø¬Ù…ÙŠØ¹ Ø±Ø³Ø§Ø¦Ù„
                                    Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                            </div>
                            <div id="chatList" class="flex-1 overflow-y-auto space-y-1 p-2">
                                <!-- Student list items injected here -->
                                <div class="text-center py-10 opacity-30">
                                    <span class="material-symbols-outlined text-4xl">forum</span>
                                    <p class="text-xs font-bold mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù†Ø´Ø·Ø©</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Box -->
                        <div
                            class="flex-1 bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 flex flex-col overflow-hidden shadow-sm relative">
                            <div id="activeChatHeader"
                                class="p-4 lg:p-6 border-b border-gray-50 dark:border-gray-800 flex items-center justify-between">
                                <div class="flex items-center gap-2 lg:gap-4">
                                    <!-- Mobile Toggle -->
                                    <button onclick="toggleChatSidebar()"
                                        class="lg:hidden size-10 flex items-center justify-center text-gray-400 hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-2xl">menu_open</span>
                                    </button>
                                    <div
                                        class="size-10 bg-primary/10 text-primary rounded-xl lg:rounded-2xl flex items-center justify-center">
                                        <span class="material-symbols-outlined text-xl lg:text-2xl"
                                            id="activeChatIcon">person</span>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-xs lg:text-base text-secondary dark:text-white leading-tight"
                                            id="activeChatTitle">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨</h3>
                                        <p class="text-[8px] lg:text-[10px] font-bold text-primary"
                                            id="activeChatStatus">Ù…ØªØµÙ„</p>
                                    </div>
                                </div>
                                <div class="flex gap-1 lg:gap-2">
                                    <button onclick="startMeeting()" id="meetingBtn"
                                        class="hidden px-3 py-1.5 lg:px-4 lg:py-2 bg-primary/10 text-primary rounded-lg lg:rounded-xl font-black text-[9px] lg:text-xs hover:bg-primary hover:text-white transition-all flex items-center gap-1 lg:gap-2">
                                        <span class="material-symbols-outlined text-sm lg:text-lg">videocam</span>
                                        <span class="hidden sm:inline">Ø§Ø¬ØªÙ…Ø§Ø¹</span>
                                        <span class="sm:hidden">Ù„Ù‚Ø§Ø¡</span>
                                    </button>
                                </div>
                            </div>

                            <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                                <!-- Messages injected here -->
                                <div class="h-full flex flex-col items-center justify-center text-center opacity-20">
                                    <span class="material-symbols-outlined text-6xl">chat</span>
                                    <p class="font-black mt-4">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø´Ø§Øª</p>
                                </div>
                            </div>

                            <div class="p-4 bg-gray-50 dark:bg-[#151e22] border-t border-gray-100 dark:border-gray-800">
                                <form id="chatForm" class="flex items-center gap-2">
                                    <button type="button" id="voiceBtn"
                                        class="size-14 bg-white dark:bg-gray-800 text-gray-400 rounded-2xl flex items-center justify-center shadow-sm hover:text-primary transition-all">
                                        <span class="material-symbols-outlined">mic</span>
                                    </button>
                                    <button type="button" onclick="document.getElementById('fileInput').click()"
                                        class="size-14 bg-white dark:bg-gray-800 text-gray-400 rounded-2xl flex items-center justify-center shadow-sm hover:text-primary transition-all">
                                        <span class="material-symbols-outlined">attach_file</span>
                                    </button>
                                    <input type="file" id="fileInput" class="hidden" multiple
                                        onchange="handleFileUpload(this.files)">
                                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                                        class="flex-1 h-14 bg-white dark:bg-gray-800 border-none rounded-2xl px-6 font-bold text-secondary dark:text-white focus:ring-2 focus:ring-primary shadow-sm">
                                    <button type="submit"
                                        class="size-14 bg-primary text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary/20 hover:scale-105 transition-all">
                                        <span class="material-symbols-outlined">send</span>
                                    </button>
                                </form>
                                <div id="recordingStatus"
                                    class="hidden items-center justify-between bg-primary/10 p-4 rounded-2xl mt-2 animate-pulse">
                                    <div class="flex items-center gap-3">
                                        <span class="size-3 bg-red-500 rounded-full"></span>
                                        <span class="text-xs font-black text-primary">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... <span
                                                id="recordTimer">00:00</span></span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="cancelRecording()"
                                            class="text-red-500 font-bold text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                                        <button onclick="stopAndSendRecording()"
                                            class="bg-primary text-white px-4 py-2 rounded-xl text-xs font-black">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="section-teachers" class="admin-section admin-only">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h1>
                            <p class="text-gray-400 font-bold">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙŠ Ø¨ÙˆØµÙ„Ø©</p>
                        </div>
                        <button onclick="openTeacherModal()"
                            class="bg-primary hover:bg-primary-dark text-white px-8 py-3.5 rounded-2xl font-black shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined">add</span>
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="teachers-grid">
                        <!-- Teachers cards injected here -->
                    </div>
                </section>

                <!-- SECTION: USERS -->
                </section>

                </section>

                <section id="section-users" class="admin-section">
                    <div class="flex justify-between items-center mb-10">
                        <div>
                            <h1 class="text-3xl font-black text-secondary dark:text-white mb-2">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h1>
                            <p class="text-gray-400 font-bold">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªØ­Ø¯ÙŠØ¯ Ø£Ø¯ÙˆØ§Ø±Ù‡Ù…</p>
                        </div>
                        <button onclick="openUserModal()"
                            class="bg-secondary text-white px-8 py-3.5 rounded-2xl font-black shadow-lg shadow-secondary/20 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined">person_add</span>
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                    <div
                        class="bg-white dark:bg-[#1a2428] rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm overflow-hidden">
                        <table class="w-full text-right">
                            <thead
                                class="bg-gray-50 dark:bg-gray-800/50 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                                <tr>
                                    <th class="px-8 py-5">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="px-8 py-5">Ø§Ù„Ø¯ÙˆØ± / Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                    <th class="px-8 py-5">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="px-8 py-5 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-gray-50 dark:divide-gray-800"></tbody>
                        </table>
                    </div>
                </section>

                <!-- SECTION: CONTENT (CALENDAR) -->

                <!-- SECTION: STATS -->
                <section id="section-stats" class="admin-section">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
                        <div>
                            <h2 class="text-3xl font-black text-secondary dark:text-white mb-2">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ©
                            </h2>
                            <p class="text-gray-400 font-bold">Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="fetchVisitStats()"
                                class="flex items-center gap-2 px-6 py-3 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl font-bold text-secondary dark:text-white hover:bg-gray-50 transition-all shadow-sm">
                                <span class="material-symbols-outlined text-sm">refresh</span>
                                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                        </div>
                    </div>

                    <!-- Top Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                        <div
                            class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-700 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-bl-full -mr-12 -mt-12 transition-transform group-hover:scale-110">
                            </div>
                            <div class="flex items-center gap-4 mb-4 relative">
                                <div
                                    class="size-12 bg-primary/10 rounded-2xl flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined">visibility</span>
                                </div>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-wider">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
                                    ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„</p>
                            </div>
                            <h3 id="totalVisitsCount"
                                class="text-3xl font-black text-secondary dark:text-white relative">0</h3>
                            <p id="conversionRate"
                                class="text-[10px] text-green-500 font-bold mt-2 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">ads_click</span>
                                0% Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                            </p>
                        </div>

                        <div
                            class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-700 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-24 h-24 bg-green-500/5 rounded-bl-full -mr-12 -mt-12 transition-transform group-hover:scale-110">
                            </div>
                            <div class="flex items-center gap-4 mb-4 relative">
                                <div
                                    class="size-12 bg-green-500/10 rounded-2xl flex items-center justify-center text-green-500">
                                    <span class="material-symbols-outlined">timer</span>
                                </div>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-wider">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¨Ù‚Ø§Ø¡
                                </p>
                            </div>
                            <h3 id="avgDuration" class="text-3xl font-black text-secondary dark:text-white relative">
                                0:00</h3>
                            <p class="text-[10px] text-gray-400 font-bold mt-2">Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙƒÙ„ Ø²Ø§Ø¦Ø±</p>
                        </div>

                        <div
                            class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-700 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-24 h-24 bg-orange-500/5 rounded-bl-full -mr-12 -mt-12 transition-transform group-hover:scale-110">
                            </div>
                            <div class="flex items-center gap-4 mb-4 relative">
                                <div
                                    class="size-12 bg-orange-500/10 rounded-2xl flex items-center justify-center text-orange-500">
                                    <span class="material-symbols-outlined">mouse</span>
                                </div>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-wider">Ø§Ù„ØªÙØ§Ø¹Ù„
                                    Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±</p>
                            </div>
                            <h3 id="totalClicks" class="text-3xl font-black text-secondary dark:text-white relative">0
                            </h3>
                            <p class="text-[10px] text-gray-400 font-bold mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø±Ø§Øª</p>
                        </div>

                        <div
                            class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] border border-gray-100 dark:border-gray-700 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-24 h-24 bg-purple-500/5 rounded-bl-full -mr-12 -mt-12 transition-transform group-hover:scale-110">
                            </div>
                            <div class="flex items-center gap-4 mb-4 relative">
                                <div
                                    class="size-12 bg-purple-500/10 rounded-2xl flex items-center justify-center text-purple-500">
                                    <span class="material-symbols-outlined">height</span>
                                </div>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-wider">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØµÙØ­
                                </p>
                            </div>
                            <h3 id="avgScroll" class="text-3xl font-black text-secondary dark:text-white relative">0%
                            </h3>
                            <p class="text-[10px] text-gray-400 font-bold mt-2">Ø¹Ù…Ù‚ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØµÙØ­Ø©</p>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                        <!-- Devices Distribution -->
                        <div
                            class="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-black text-secondary dark:text-white mb-8">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
                            </h3>
                            <div class="h-[300px] flex items-center justify-center">
                                <canvas id="deviceChart"></canvas>
                            </div>
                        </div>

                        <!-- Visits Over Time -->
                        <div
                            class="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-black text-secondary dark:text-white mb-8">Ù†Ø´Ø§Ø· Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                            </h3>
                            <div class="h-[300px]">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>

                        <!-- Top Clicked Buttons -->
                        <div
                            class="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-black text-secondary dark:text-white mb-8">Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¬Ø°Ø¨Ø§Ù‹
                                Ù„Ù„Ù†Ù‚Ø±Ø§Øª</h3>
                            <div class="h-[300px]">
                                <canvas id="clickChart"></canvas>
                            </div>
                        </div>

                        <!-- Most Viewed Sections -->
                        <div
                            class="bg-white dark:bg-gray-800 p-8 rounded-[2.5rem] border border-gray-100 dark:border-gray-700 shadow-sm">
                            <h3 class="text-lg font-black text-secondary dark:text-white mb-8">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©
                                (Heatmap)</h3>
                            <div class="h-[300px]">
                                <canvas id="sectionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Table -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-[2.5rem] border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
                        <div
                            class="p-8 border-b border-gray-50 dark:border-gray-700 flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-black text-secondary dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>

                            <!-- Filters Container -->
                            <div class="flex flex-wrap items-center gap-3">
                                <!-- Time Filter -->
                                <select id="statsTimeFilter" onchange="fetchVisitStats()"
                                    class="text-[10px] font-bold bg-gray-50 dark:bg-gray-700 border-none rounded-xl px-4 py-2 focus:ring-primary">
                                    <option value="all">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option>
                                    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                                    <option value="yesterday">Ø£Ù…Ø³</option>
                                    <option value="week">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
                                </select>

                                <!-- Device Filter -->
                                <select id="statsDeviceFilter" onchange="fetchVisitStats()"
                                    class="text-[10px] font-bold bg-gray-50 dark:bg-gray-700 border-none rounded-xl px-4 py-2 focus:ring-primary">
                                    <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>
                                    <option value="Desktop">Desktop</option>
                                    <option value="Mobile">Mobile</option>
                                    <option value="Tablet">Tablet</option>
                                </select>

                                <!-- Platform Filter -->
                                <select id="statsPlatformFilter" onchange="fetchVisitStats()"
                                    class="text-[10px] font-bold bg-gray-50 dark:bg-gray-700 border-none rounded-xl px-4 py-2 focus:ring-primary">
                                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
                                    <option value="Direct">Direct</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="linkedin">LinkedIn</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="google">Google</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead>
                                    <tr
                                        class="bg-gray-50/50 dark:bg-gray-900/50 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                        <th class="px-8 py-5">Ø§Ù„Ø²Ø§Ø¦Ø± ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                        <th class="px-8 py-5">Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù†Ø¸Ø§Ù…</th>
                                        <th class="px-8 py-5">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù…ØµØ¯Ø±</th>
                                        <th class="px-8 py-5">Ù…Ø¯Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙˆØ§Ù„ÙˆØµÙˆÙ„</th>
                                        <th class="px-8 py-5">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody" class="divide-y divide-gray-50 dark:divide-gray-800">
                                    <tr>
                                        <td colspan="4" class="text-center py-20 opacity-30 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„
                                            Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Modal Backdrop -->
        <div id="applicantModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6 sm:px-0">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

            <div
                class="relative mx-auto mt-10 max-w-4xl bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-6 lg:p-10 shadow-2xl transform transition-all overflow-hidden border border-white/20">
                <div
                    class="absolute top-0 right-0 w-48 h-48 bg-primary/5 rounded-bl-full -mr-24 -mt-24 pointer-events-none">
                </div>

                <div class="flex justify-between items-start mb-8 relative">
                    <div class="flex items-center gap-4">
                        <div class="size-16 bg-primary/10 rounded-3xl flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-4xl">account_circle</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-secondary">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
                            <p class="text-gray-400 text-sm font-bold">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                        </div>
                    </div>
                    <button onclick="closeModal()"
                        class="size-10 bg-gray-100 hover:bg-gray-200 rounded-2xl flex items-center justify-center text-gray-500 transition-all">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div id="applicantDetails" class="space-y-6 relative">
                    <!-- Details injected here -->
                </div>

                <div class="mt-10 pt-8 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3">
                    <button onclick="closeModal()"
                        class="px-8 py-3 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-black rounded-2xl transition-all">Ø¥ØºÙ„Ø§Ù‚</button>
                    <div id="modalActionContainer"></div>
                </div>
            </div>
        </div>

        <!-- CONTENT MODAL -->

        <!-- Teacher Modal -->
        <div id="teacherModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeTeacherModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-2xl bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 lg:p-10 shadow-2xl transition-all border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6" id="teacherModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³
                    Ø¬Ø¯ÙŠØ¯</h2>
                <form id="teacherForm" class="space-y-6">
                    <input type="hidden" id="teacherId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³</label>
                            <input type="text" id="teacherName" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ù„ØªØ®ØµØµ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                            <input type="text" id="teacherSubject" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="teacherPhone"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="url" id="teacherImage"
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white"
                                placeholder="https://...">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„)</label>
                            <input type="text" id="teacherUsername" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="text" id="teacherPassword" required
                                class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white"
                                placeholder="Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ± (Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ù†Ø¨Ø°Ø© ØªØ¹Ø±ÙŠÙÙŠØ©</label>
                        <textarea id="teacherBio" rows="4"
                            class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-2xl p-4 font-bold text-secondary dark:text-white"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeTeacherModal()"
                            class="px-8 py-3 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold rounded-2xl">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit"
                            class="px-8 py-3 bg-primary text-white font-black rounded-2xl shadow-lg shadow-primary/20">Ø­ÙØ¸
                            Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </form>
            </div>
        </div>


        <!-- User Modal -->
        <div id="userModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeUserModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <h2 class="text-2xl font-black text-secondary dark:text-white mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <form id="userForm" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="username" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="userPassword" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                        <select id="userRole"
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="teacher">Ù…Ø¯Ø±Ø³ (ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø©)</option>
                            <option value="admin">Ù…Ø³Ø¤ÙˆÙ„ ÙƒØ§Ù…Ù„ (Admin)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full py-4 bg-secondary text-white font-black rounded-2xl mt-4">Ø¥Ø¶Ø§ÙØ©
                        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                </form>
            </div>
        </div>
        <!-- Convert Modal -->
        <div id="convertModal" class="fixed inset-0 z-[200] hidden overflow-y-auto px-4 py-6">
            <div class="fixed inset-0 bg-secondary/80 backdrop-blur-sm" onclick="closeConvertModal()"></div>
            <div
                class="relative mx-auto mt-10 max-w-lg bg-white dark:bg-[#1a2428] rounded-[2.5rem] p-8 shadow-2xl border border-white/20">
                <div class="flex items-center gap-4 mb-8">
                    <div class="size-12 bg-primary/10 rounded-2xl flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined">upgrade</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-secondary dark:text-white">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ù…Ø´ØªØ±Ùƒ</h2>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ø¬Ø§Ù„
                        </p>
                    </div>
                </div>

                <form id="convertForm" class="space-y-6">
                    <input type="hidden" id="convertApplicantId">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                        <p id="convertApplicantName" class="font-black text-secondary dark:text-white"></p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø§Ù„Ù…Ø¬Ø§Ù„ / Ø§Ù„ØªØ®ØµØµ</label>
                        <select id="convertSpecialization" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="Web Development">Web Development</option>
                            <option value="Digital Marketing">Digital Marketing</option>
                            <option value="Content Creation">Content Creation</option>
                            <option value="Freelancing">Freelancing</option>
                            <option value="Tech Skills">Tech Skills</option>
                            <option value="Soft Skills">Soft Skills</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400">Ø¨Ø§Ù‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                        <select id="convertPlan" required
                            class="w-full h-12 bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 font-bold text-secondary dark:text-white">
                            <option value="Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (50 Ø¬.Ù…)">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (50 Ø¬.Ù…)</option>
                            <option value="Ù…Ø­ØªØ±Ù (150 Ø¬.Ù…)">Ù…Ø­ØªØ±Ù (150 Ø¬.Ù…)</option>
                            <option value="Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)">Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeConvertModal()"
                            class="flex-1 py-4 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold rounded-2xl">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit"
                            class="flex-1 py-4 bg-primary text-white font-black rounded-2xl shadow-lg shadow-primary/20">ØªØ£ÙƒÙŠØ¯
                            Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Appwrite SDK -->
        <script src="https://cdn.jsdelivr.net/npm/appwrite@16.1.0"></script>
        <script src="../assets/js/appwrite.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

        <script>
            // --- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© (Authentication) ---
            const userRole = sessionStorage.getItem('user_role') || 'teacher';
            const adminAuth = sessionStorage.getItem('admin_auth');

            if (adminAuth !== 'true') {
                window.location.href = 'index.html';
            }

            // Role-based visibility
            if (userRole === 'teacher') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                // If they try to access restricted sections via URL (if we had routing), we'd block it here.
            }

            function logout() {
                sessionStorage.removeItem('admin_auth');
                sessionStorage.removeItem('user_role');
                window.location.href = 'index.html';
            }

            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('sidebar-open');
                overlay.classList.toggle('active');
            }

            function switchSection(sectionId) {
                // If sidebar is open (on mobile), close it when a section is selected
                if (window.innerWidth <= 1024) {
                    const sidebar = document.querySelector('.sidebar');
                    const overlay = document.getElementById('sidebarOverlay');
                    if (sidebar.classList.contains('sidebar-open')) {
                        sidebar.classList.remove('sidebar-open');
                        overlay.classList.remove('active');
                    }
                }
                // Role-based section restriction
                if (userRole === 'teacher' && (sectionId === 'users' || sectionId === 'finance' || sectionId === 'applicants' || sectionId === 'teachers' || sectionId === 'stats')) {
                    alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
                    return;
                }

                // Hide all sections
                document.querySelectorAll('.admin-section').forEach(sec => sec.classList.remove('active'));
                // Show selected section
                const targetSection = document.getElementById(`section-${sectionId}`);
                if (targetSection) targetSection.classList.add('active');

                // Update sidebar active state
                document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                const targetNav = document.getElementById(`nav-${sectionId}`);
                if (targetNav) targetNav.classList.add('active');

                // Fetch data for the section if needed
                if (sectionId === 'teachers' && userRole === 'admin') fetchTeachers();
                if (sectionId === 'users' && userRole === 'admin') fetchUsers();
                if (sectionId === 'messages') updateChatList();
                if (sectionId === 'stats') fetchVisitStats();
                if (sectionId === 'content') initCalendar();
                if (sectionId === 'consultations') renderConsultations();
            }


            // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (client, databases, etc.) Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† appwrite-config.js
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙÙ‡Ø§ Ù‡Ù†Ø§

            function formatWhatsAppPhone(phone) {
                if (!phone) return "";
                let cleanPhone = phone.toString().replace(/\D/g, '');
                if (cleanPhone.startsWith('0')) {
                    return '2' + cleanPhone;
                }
                return cleanPhone;
            }

            const tableContainer = document.getElementById('table-container');
            const applicantCount = document.getElementById('applicantCount');
            const loadingData = document.getElementById('loading-data');
            const errorMessage = document.getElementById('error-message');
            const searchInput = document.getElementById('searchInput');
            const specializationFilter = document.getElementById('specializationFilter');
            const currentDateEl = document.getElementById('currentDate');

            // Set Current Date - Safe check
            if (currentDateEl) {
                currentDateEl.textContent = new Date().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            let applicants = [];

            function populateFilters() {
                // Get unique values excluding 'Free Consultation'
                const regularApps = applicants.filter(a => a.plan !== 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const specs = [...new Set(regularApps.map(a => a.specialization).filter(Boolean))];
                const plans = [...new Set(regularApps.map(a => a.plan).filter(Boolean))];

                const specSelect = document.getElementById('specializationFilter');
                const planSelect = document.getElementById('planFilter');

                // Preserve the first option (All) and append new
                /*
                // Static population is already done in initFilters, but we can enhance it dynamically if needed.
                // For now, let's stick to update logic logic if we want dynamic only.
                // But the user requested design match, static might be safer for "All Specializations".
                // Let's just ensure listeners are attached.
                */
                // Re-attach listeners just in case
                specSelect.onchange = filter; // Use filter() instead of processApplicants
                planSelect.onchange = filter;
            }

            async function fetchApplicants() {
                loadingData.style.display = 'block';
                try {
                    let queries = [Query.orderDesc('timestamp')];
                    if (sessionStorage.getItem('user_role') === 'teacher') {
                        const uid = sessionStorage.getItem('user_id');
                        if (uid) queries.push(Query.equal('teacherId', uid));
                    }

                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, queries);
                    applicants = response.documents.map(doc => ({ id: doc.$id, ...doc }));

                    if (sessionStorage.getItem('user_role') === 'admin') {
                        await fetchTeachers();
                    }

                    // Attach Listeners
                    document.getElementById('specializationFilter').onchange = filter;
                    document.getElementById('planFilter').onchange = filter;
                    document.getElementById('paymentFilter').onchange = filter;
                    document.getElementById('resetSearchBtn').onclick = () => {
                        searchInput.value = '';
                        document.getElementById('specializationFilter').value = '';
                        document.getElementById('planFilter').value = '';
                        document.getElementById('paymentFilter').value = '';
                        filter();
                    };

                    processApplicants();

                    client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTIONS.APPLICANTS}.documents`, response => {
                        if (response.events.some(e => e.includes('.create') || e.includes('.update') || e.includes('.delete'))) {
                            fetchApplicants();
                        }
                    });
                } catch (err) {
                    errorMessage.classList.remove('hidden');
                    errorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message;
                } finally {
                    loadingData.style.display = 'none';
                }
            }

            function processApplicants() {
                // Update Stats for Applicants
                const activeApps = applicants.filter(a => a.status === 'Ù†Ø´Ø·');
                const statsEl = document.getElementById('activeCountStats');
                if (statsEl) statsEl.textContent = activeApps.length;

                // Expiring logic
                const now = new Date();
                const expiringApps = applicants.filter(a => {
                    if (!a.timestamp) return false;
                    const expiry = new Date(new Date(a.timestamp).getTime() + (30 * 24 * 60 * 60 * 1000));
                    const diff = expiry - now;
                    return diff > 0 && diff < (5 * 24 * 60 * 60 * 1000);
                });
                const expiringStatsEl = document.getElementById('expiringCountStats');
                if (expiringStatsEl) expiringStatsEl.textContent = expiringApps.length;

                // Update consultation counts
                const consultationApps = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const badge = document.querySelector('.consultation-count-badge');
                if (badge) badge.textContent = `${consultationApps.length} Ø·Ù„Ø¨`;

                filter();
                if (typeof updateChatList === 'function') updateChatList();
            }

            // --- Dynamic Filter Population ---
            function initFilters() {
                // Static paths based on the website form
                const paths = ['Web Development', 'Digital Marketing', 'Content Creation', 'Freelancing', 'Tech Skills', 'Soft Skills'];
                specializationFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ®ØµØµØ§Øª</option>' +
                    paths.map(p => `<option value="${p}">${p}</option>`).join('');

                // Static plans based on the website form
                const plans = ['Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (50 Ø¬.Ù…)', 'Ù…Ø­ØªØ±Ù (150 Ø¬.Ù…)', 'Ù…Ù†ØªÙˆØ± (500 Ø¬.Ù…)'];
                const planSelect = document.getElementById('planFilter');
                planSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</option>' +
                    plans.map(p => `<option value="${p}">${p}</option>`).join('');
            }
            initFilters();

            // --- Teachers Management ---
            function openTeacherModal(teacher = null) {
                document.getElementById('teacherModal').classList.remove('hidden');
                const title = document.getElementById('teacherModalTitle');
                const form = document.getElementById('teacherForm');

                if (teacher) {
                    title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³';
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name || '';
                    document.getElementById('teacherSubject').value = teacher.subject || '';
                    document.getElementById('teacherPhone').value = teacher.phone || '';
                    document.getElementById('teacherImage').value = teacher.image || '';
                    document.getElementById('teacherBio').value = teacher.bio || '';
                } else {
                    title.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯';
                    form.reset();
                    document.getElementById('teacherId').value = '';
                }
            }

            function closeTeacherModal() {
                document.getElementById('teacherModal').classList.add('hidden');
            }

            document.getElementById('teacherForm').onsubmit = async (e) => {
                e.preventDefault();
                const teacherId = document.getElementById('teacherId').value;
                const username = document.getElementById('teacherUsername').value;
                const password = document.getElementById('teacherPassword').value;

                const data = {
                    name: document.getElementById('teacherName').value,
                    subject: document.getElementById('teacherSubject').value,
                    phone: document.getElementById('teacherPhone').value,
                    image: document.getElementById('teacherImage').value,
                    bio: document.getElementById('teacherBio').value,
                    username: username,
                    role: 'teacher',
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (teacherId) {
                        if (password) data.password = password;
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.ADMINS, teacherId, data);
                    } else {
                        if (!password) { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }
                        data.password = password;
                        data.createdAt = new Date().toISOString();
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.ADMINS, ID.unique(), data);
                    }
                    closeTeacherModal();
                    fetchTeachers();
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + err.message);
                }
            };

            let allTeachers = [];
            async function fetchTeachers() {
                const grid = document.getElementById('teachers-grid');
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [
                        Query.equal('role', 'teacher')
                    ]);
                    allTeachers = response.documents;
                    grid.innerHTML = response.documents.map(t => {
                        return `
                                    <div class="bg-white dark:bg-[#1a2428] rounded-[2rem] p-6 border border-gray-100 dark:border-gray-800 shadow-sm group">
                                        <div class="flex items-center gap-4 mb-4">
                                            <img src="${t.image || 'https://via.placeholder.com/100'}" class="size-16 rounded-2xl object-cover">
                                            <div>
                                                <h3 class="font-black text-secondary dark:text-white">${t.name}</h3>
                                                <p class="text-primary text-xs font-bold">${t.subject}</p>
                                            </div>
                                        </div>
                                        <p class="text-gray-400 text-xs font-bold mb-6 line-clamp-2">${t.bio || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                                        <div class="flex gap-2">
                                            <button onclick='openTeacherModal(${JSON.stringify({ id: t.$id, ...t }).replace(/'/g, "&apos;")})' class="flex-1 py-2.5 bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-400 font-bold rounded-xl text-xs hover:bg-primary/10 hover:text-primary transition-all">ØªØ¹Ø¯ÙŠÙ„</button>
                                            <button onclick="deleteTeacher('${t.$id}')" class="px-4 py-2.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all"><span class="material-symbols-outlined text-sm">delete</span></button>
                                        </div>
                                    </div>
                                `;
                    }).join('');
                } catch (e) {
                    console.error('Error fetching teachers:', e);
                }
            }

            async function deleteTeacher(id) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ØŸ')) {
                    try {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.ADMINS, id);
                        fetchTeachers();
                    } catch (e) {
                        alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³');
                    }
                }
            }

            // --- Users Management ---
            function openUserModal() {
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userForm').reset();
            }
            function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

            document.getElementById('userForm').onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    username: document.getElementById('username').value,
                    password: document.getElementById('userPassword').value,
                    role: document.getElementById('userRole').value,
                    createdAt: new Date().toISOString()
                };
                try {
                    // Check if username exists
                    const existing = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [
                        Query.equal('username', data.username)
                    ]);
                    if (existing.documents.length > 0) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');

                    await databases.createDocument(DATABASE_ID, COLLECTIONS.ADMINS, ID.unique(), data);
                    closeUserModal();
                    fetchUsers();
                } catch (err) {
                    alert('Ø®Ø·Ø£: ' + err.message);
                }
            }

            async function fetchUsers() {
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS);
                    const list = response.documents;
                    const usersCountEl = document.getElementById('usersCount');
                    if (usersCountEl) usersCountEl.textContent = list.length;

                    const table = document.getElementById('usersTableBody');
                    if (table) {
                        table.innerHTML = list.map(u => {
                            return `
                                <tr class="hover:bg-primary/5 transition-colors">
                                    <td class="px-8 py-5 whitespace-nowrap">
                                        <div class="flex items-center gap-3">
                                            <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-primary">
                                                <span class="material-symbols-outlined">shield_person</span>
                                            </div>
                                            <span class="font-bold text-secondary dark:text-white">${u.username}</span>
                                        </div>
                                    </td>
                                    <td class="px-8 py-5">
                                        <span class="px-3 py-1 ${u.role === 'admin' ? 'bg-purple-100 text-purple-600' : 'bg-orange-100 text-orange-600'} rounded-lg text-[10px] font-black">
                                            ${u.role === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„ ÙƒØ§Ù…Ù„' : 'Ù…Ø¯Ø±Ø³'}
                                        </span>
                                    </td>
                                    <td class="px-8 py-5">
                                        <div class="flex items-center gap-2">
                                            <span class="size-2 rounded-full bg-green-500"></span>
                                            <span class="text-xs font-bold text-gray-500">Ù†Ø´Ø·</span>
                                        </div>
                                    </td>
                                    <td class="px-8 py-5 text-center">
                                        <button onclick="deleteUser('${u.$id}')" class="text-red-500 hover:scale-110 transition-transform">
                                            <span class="material-symbols-outlined text-xl">delete</span>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                } catch (e) {
                    console.error("Error fetching users:", e);
                }
            }

            async function deleteUser(id) {
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                    try {
                        await databases.deleteDocument(DATABASE_ID, COLLECTIONS.ADMINS, id);
                        fetchUsers();
                    } catch (e) { alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); }
                }
            }

            // --- Unified Theme Logic ---
            const themeToggle = document.getElementById('darkModeToggleSidebar');
            function updateThemeUI(isDark) {
                const icon = themeToggle?.querySelector('.theme-icon');
                if (icon) icon.textContent = isDark ? 'light_mode' : 'dark_mode';
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                }
            }
            if (themeToggle) {
                themeToggle.onclick = () => {
                    const isDark = !document.documentElement.classList.contains('dark');
                    localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
                    updateThemeUI(isDark);
                };
            }
            // Sync UI state with current theme
            updateThemeUI(document.documentElement.classList.contains('dark'));

            function renderApplicants(list) {
                const isTeacher = sessionStorage.getItem('user_role') === 'teacher';
                const isAdmin = !isTeacher;

                applicantCount.textContent = list.length;
                if (list.length === 0) {
                    tableContainer.innerHTML = '<div class="p-20 text-center text-gray-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ</div>';
                    return;
                }

                // Headers
                const paymentHeader = isAdmin ? '<th class="px-6 py-4 text-center">Ø§Ù„Ø¯ÙØ¹</th>' : '';
                const teacherHeader = isAdmin ? '<th class="px-6 py-4 text-right">Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>' : '';

                let html = `
                <div class="overflow-x-auto rounded-3xl border border-gray-100 dark:border-gray-800">
                    <table class="w-full text-right border-collapse bg-white dark:bg-[#151e22]">
                    <thead class="bg-gray-50 border-b border-gray-100 dark:border-gray-800 uppercase text-[10px] font-black text-gray-500">
                        <tr>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø§Ù‚Ø©</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„ØªØ®ØµØµ</th>
                            ${paymentHeader}
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            ${teacherHeader}
                            <th class="px-6 py-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
                `;

                list.forEach(applicant => {
                    const date = applicant.timestamp ? new Date(applicant.timestamp) : null;

                    // Timer Logic
                    let timerHtml = '<span class="text-gray-400">--</span>';
                    if (date) {
                        const expiryDate = new Date(date.getTime() + (30 * 24 * 60 * 60 * 1000));
                        const now = new Date();
                        const diff = expiryDate - now;
                        if (diff > 0) {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const color = days < 5 ? 'text-orange-500' : 'text-green-500';
                            timerHtml = `<span class="font-bold text-xs ${color}">${days} ÙŠÙˆÙ…</span>`;
                        } else {
                            timerHtml = `<span class="font-bold text-xs text-red-500">Ù…Ù†ØªÙ‡ÙŠ</span>`;
                        }
                    }

                    // Payment Cell
                    const paymentCell = isAdmin ? `
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <button onclick="togglePayment('${applicant.id}', '${applicant.paymentStatus}')" 
                                class="size-8 rounded-full border-2 transition-all flex items-center justify-center mx-auto
                                ${applicant.paymentStatus === 'paid' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200 text-gray-300 hover:border-green-500'}">
                                <span class="material-symbols-outlined text-lg">${applicant.paymentStatus === 'paid' ? 'check' : 'payments'}</span>
                            </button>
                        </td>` : '';

                    // Teacher Cell
                    let teacherCell = '';
                    if (isAdmin) {
                        let options = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³ --</option>';
                        allTeachers.forEach(t => {
                            const sel = applicant.teacherId === t.$id ? 'selected' : '';
                            options += `<option value="${t.$id}" ${sel}>${t.name}</option>`;
                        });
                        teacherCell = `
                        <td class="px-6 py-5">
                            <div class="relative group/select w-36">
                                <select onchange="assignTeacher('${applicant.id}', this.value)" 
                                    class="appearance-none w-full bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700/50 rounded-xl text-xs font-bold py-2.5 px-3 cursor-pointer focus:ring-2 focus:ring-primary/20 transition-all text-secondary dark:text-gray-300 pr-8 hover:border-gray-300 dark:hover:border-gray-600">
                                    ${options}
                                </select>
                                <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none group-hover/select:text-primary transition-colors">expand_more</span>
                            </div>
                        </td>`;
                    }

                    html += `
                    <tr class="hover:bg-primary/5 transition-colors group border-b border-gray-50 dark:border-gray-800/50 last:border-none">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-gray-400 group-hover:bg-primary/20 group-hover:text-primary transition-all shadow-sm">
                                    <span class="material-symbols-outlined text-lg">person</span>
                                </div>
                                <div class="flex flex-col">
                                    <h4 class="font-bold text-secondary dark:text-white text-sm mb-0.5">${applicant.name}</h4>
                                    <span class="text-[10px] text-gray-400 font-bold bg-gray-50 dark:bg-gray-800 px-2 py-0.5 rounded-lg w-fit border border-gray-100 dark:border-gray-700/50">${isAdmin ? (applicant.plan || '--') : 'Ù…Ø³Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="px-3 py-1.5 bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-gray-500 dark:text-gray-400 rounded-lg text-[10px] font-black shadow-sm">
                                ${applicant.specialization || '-'}
                            </span>
                        </td>
                        ${paymentCell}
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="relative w-32">
                                <select onchange="updateStatus('${applicant.id}', this.value)" 
                                    class="w-full appearance-none pl-3 pr-8 py-2 rounded-xl text-[10px] font-black cursor-pointer transition-all border focus:ring-2 focus:ring-primary/20 hover:shadow-sm ${applicant.status === 'Ù†Ø´Ø·' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-gray-50 text-gray-500 border-gray-200'}">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${applicant.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist</option>
                                    <option value="Ù†Ø´Ø·" ${applicant.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active</option>
                                    <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${applicant.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Help</option>
                                    <option value="Ù…ØªÙˆÙ‚Ù" ${applicant.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused</option>
                                    <option value="Ù…Ù†Ø³Ø­Ø¨" ${applicant.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped</option>
                                </select>
                                <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-[10px] opacity-60 pointer-events-none">expand_more</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">${timerHtml}</td>
                        ${teacherCell}
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="viewApplicant('${applicant.id}')" class="size-9 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-xl flex items-center justify-center transition-all shadow-sm" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </button>
                                ${isAdmin ? `<button onclick="deleteApplicant('${applicant.id}')" class="size-9 bg-red-50 dark:bg-red-900/10 text-red-500 hover:bg-red-500 hover:text-white rounded-xl flex items-center justify-center transition-all shadow-sm" title="Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨"><span class="material-symbols-outlined text-lg">delete</span></button>` : ''}
                            </div>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                tableContainer.innerHTML = html;
            }

            async function assignTeacher(applicantId, teacherId) {
                try {
                    const teacher = allTeachers.find(t => t.$id === teacherId);
                    const teacherName = teacher ? teacher.name : '';
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, applicantId, {
                        teacherId: teacherId,
                        teacherName: teacherName
                    });
                    // Refresh not needed if we trust UI update, but safer to refresh
                } catch (e) {
                    alert("ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯Ø±Ø³");
                    console.error(e);
                }
            }

            function renderConsultations() {
                const term = document.getElementById('consultationSearchInput')?.value.toLowerCase() || "";
                const list = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const filtered = list.filter(a =>
                    a.name?.toLowerCase().includes(term) ||
                    a.specialization?.toLowerCase().includes(term) ||
                    a.phone?.includes(term)
                );

                const container = document.getElementById('consultation-table-container');
                document.querySelector('.consultation-count-badge').textContent = `${filtered.length} Ø·Ù„Ø¨`;

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="p-20 text-center text-gray-400 font-bold">${term ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ´Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'}</div>`;
                    return;
                }

                let html = `
                <table class="w-full text-right border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-100 dark:border-gray-800 uppercase text-[10px] font-black text-gray-500">
                        <tr>
                            <th class="px-6 py-4 text-right">ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡</th>
                            <th class="px-6 py-4 text-right">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th class="px-6 py-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-6 py-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50 dark:divide-gray-800">
            `;

                filtered.forEach(a => {
                    html += `
                    <tr class="hover:bg-primary/5 transition-colors group">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="size-8 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-outlined text-sm">event_available</span>
                                </div>
                                <span class="font-bold text-secondary text-sm">${a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-500 rounded-full text-[10px] font-black">
                                ${a.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                            </span>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap font-bold text-xs" dir="ltr">
                            ${a.phone || '--'}
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <select onchange="updateStatus('${a.id}', this.value)" 
                                class="text-[10px] font-black border-none rounded-lg py-1 px-2 cursor-pointer transition-all dark:bg-gray-800
                                ${a.status === 'Ù†Ø´Ø·' ? 'bg-green-100 text-green-600' :
                            a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'bg-blue-100 text-blue-600' :
                                a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'bg-yellow-100 text-yellow-600' :
                                    a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'bg-red-100 text-red-600' :
                                        a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-500'}">
                                <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist ğŸ”µ</option>
                                <option value="Ù†Ø´Ø·" ${a.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active ğŸŸ¢</option>
                                <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Needs Help ğŸŸ¡</option>
                                <option value="Ù…ØªÙˆÙ‚Ù" ${a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused ğŸ”´</option>
                                <option value="Ù…Ù†Ø³Ø­Ø¨" ${a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped âš«</option>
                            </select>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="viewApplicant('${a.id}')" class="size-9 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-xl flex items-center justify-center transition-all">
                                    <span class="material-symbols-outlined text-xl">visibility</span>
                                </button>
                                <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="size-9 bg-green-50 text-green-500 hover:bg-green-500 hover:text-white rounded-xl flex items-center justify-center transition-all">
                                    <span class="material-symbols-outlined text-xl">chat</span>
                                </a>
                                <button onclick="openConvertModal('${a.id}', '${a.name || ''}', '${a.specialization || ''}')" class="size-9 bg-orange-50 text-orange-500 hover:bg-orange-500 hover:text-white rounded-xl flex items-center justify-center transition-all" title="ØªØ­ÙˆÙŠÙ„ Ù„Ø·Ø§Ù„Ø¨">
                                    <span class="material-symbols-outlined text-xl">upgrade</span>
                                </button>
                                <button onclick="deleteApplicant('${a.id}')" class="size-9 bg-red-50 text-red-500 hover:bg-red-500 hover:text-white rounded-xl flex items-center justify-center transition-all">
                                    <span class="material-symbols-outlined text-xl">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function exportConsultationsToExcel() {
                const list = applicants.filter(a => a.plan === 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["Ø§Ù„Ø§Ø³Ù…", "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ù‡", "Ø§Ù„Ø­Ø§Ù„Ø©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨"]
                ];
                list.forEach(a => {
                    ws_data.push([
                        a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        a.status || 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                        a.timestamp ? new Date(a.timestamp.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©");
                XLSX.writeFile(wb, "bosla-consultations.xlsx");
            }

            function openConvertModal(id, name, specialization) {
                document.getElementById('convertApplicantId').value = id;
                document.getElementById('convertApplicantName').textContent = name;
                document.getElementById('convertSpecialization').value = specialization || "Web Development";
                document.getElementById('convertModal').classList.remove('hidden');
            }

            function closeConvertModal() {
                document.getElementById('convertModal').classList.add('hidden');
            }

            document.getElementById('convertForm').onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById('convertApplicantId').value;
                const specialization = document.getElementById('convertSpecialization').value;
                const plan = document.getElementById('convertPlan').value;

                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        specialization: specialization,
                        plan: plan,
                        status: 'Ù†Ø´Ø·', // Set as active student
                        timestamp: new Date().toISOString() // Reset date to subscription start
                    });

                    closeConvertModal();
                    alert('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ØªØ¬Ø¯Ù‡ Ø§Ù„Ø¢Ù† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨.');

                    // Switch to students section
                    switchSection('applicants');
                    fetchApplicants(); // Refresh the list
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ' + err.message);
                }
            };

            async function updateField(id, field, value) {
                try {
                    const updateData = {};
                    updateData[field] = value;
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, updateData);
                    const app = applicants.find(a => a.id === id);
                    if (app) app[field] = value;
                    console.log(`Updated ${field} for ${id}`);
                } catch (error) {
                    console.error("Error updating field:", error);
                }
            }

            async function viewApplicant(id) {
                try {
                    const a = await databases.getDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id);
                    const timestampDate = a.timestamp ? new Date(a.timestamp) : new Date();
                    const autoStart = timestampDate.toLocaleDateString('ar-EG');
                    const autoEnd = new Date(timestampDate.getTime() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('ar-EG');

                    const startDate = a.subscriptionStart || autoStart;
                    const endDate = a.subscriptionEnd || autoEnd;

                    document.getElementById('applicantDetails').innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Right Column: Personal & Basic Info -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-primary">person</span>
                                    Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                                </h3>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
                                        <p class="font-bold text-secondary dark:text-white text-base">${a.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
                                        <div class="flex items-center gap-2">
                                            <p class="font-bold text-secondary dark:text-white text-base" dir="ltr">${a.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
                                            <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="text-green-500 hover:scale-110 transition-transform">
                                                <span class="material-symbols-outlined text-lg">chat</span>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                                        <p class="font-bold text-primary text-base">${a.specialization || '--'}</p>
                                    </div>
                                    <div class="space-y-1 pt-2 border-t border-gray-100 dark:border-gray-800">
                                        <span class="text-[10px] font-black text-orange-500 uppercase tracking-widest">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                                        <div class="flex gap-2">
                                            <input type="text" value="${a.password || ''}" placeholder="ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
                                                class="flex-1 h-10 bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700 rounded-xl px-3 text-xs font-bold"
                                                onblur="updateField('${id}', 'password', this.value)">
                                        </div>
                                        <p class="text-[9px] text-gray-400">Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©</p>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ø¨Ø¯Ø£ ÙÙŠ</span>
                                        <p class="font-bold text-secondary dark:text-white text-sm">${a.timestamp ? new Date(a.timestamp).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-orange-500">traffic</span>
                                    Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨
                                </h3>
                                <select onchange="updateStatus('${id}', this.value)" 
                                    class="w-full text-xs font-black border-none rounded-xl py-3 px-4 cursor-pointer transition-all dark:bg-gray-800
                                    ${a.status === 'Ù†Ø´Ø·' ? 'bg-green-100 text-green-600' :
                            a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'bg-blue-100 text-blue-600' :
                                a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'bg-yellow-100 text-yellow-600' :
                                    a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'bg-red-100 text-red-600' :
                                        a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-500'}">
                                    <option value="ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" ${a.status === 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>Waitlist ğŸ”µ (Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</option>
                                    <option value="Ù†Ø´Ø·" ${a.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Active ğŸŸ¢ (Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„)</option>
                                    <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©" ${a.status === 'ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©' ? 'selected' : ''}>Needs Help ğŸŸ¡</option>
                                    <option value="Ù…ØªÙˆÙ‚Ù" ${a.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Paused ğŸ”´</option>
                                    <option value="Ù…Ù†Ø³Ø­Ø¨" ${a.status === 'Ù…Ù†Ø³Ø­Ø¨' ? 'selected' : ''}>Dropped âš«</option>
                                </select>
                            </div>

                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-purple-500">psychology</span>
                                    Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„
                                </h3>
                                <select id="teacherAssignmentSelect" onchange="updateField('${id}', 'teacherId', this.value)" 
                                    class="w-full text-xs font-black border-none rounded-xl py-3 px-4 cursor-pointer transition-all dark:bg-gray-800 bg-white">
                                    <option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
                                </select>
                            </div>

                            <div class="bg-gray-50 dark:bg-[#151e22] p-6 rounded-3xl border border-gray-100 dark:border-gray-800">
                                <h3 class="flex items-center gap-2 text-sm font-black text-secondary dark:text-white mb-4">
                                    <span class="material-symbols-outlined text-blue-500">payments</span>
                                    Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯ÙØ¹
                                </h3>
                                <div class="space-y-3">
                                    <input type="text" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©" value="${a.plan || ''}" 
                                        class="w-full h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                        onblur="updateField('${id}', 'plan', this.value)">
                                    <div class="flex gap-2">
                                        <input type="text" placeholder="Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" value="${startDate}" 
                                            class="w-1/2 h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'subscriptionStart', this.value)">
                                        <input type="text" placeholder="Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" value="${endDate}" 
                                            class="w-1/2 h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'subscriptionEnd', this.value)">
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-xl border border-gray-100 dark:border-gray-600">
                                        <span class="text-[10px] font-black text-gray-400">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</span>
                                        <button onclick="togglePayment('${id}', '${a.paymentStatus}')" 
                                            class="px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${a.paymentStatus === 'paid' ? 'bg-green-500 text-white' : 'bg-red-100 text-red-500'}">
                                            ${a.paymentStatus === 'paid' ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' : 'Ù„Ù… ÙŠØ¯ÙØ¹'}
                                        </button>
                                    </div>
                                    <input type="number" placeholder="Ø¬Ù„Ø³Ø§Øª 1:1 Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" value="${a.oneToOneSessions || 0}" 
                                        class="w-full h-11 bg-white dark:bg-gray-700 border-gray-100 dark:border-gray-600 rounded-xl px-4 text-xs font-bold"
                                        onblur="updateField('${id}', 'oneToOneSessions', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Left Column: Detailed Info -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Target Section -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">target</span>
                                    ğŸ¯ Ù‡Ø¯Ù Ø§Ù„Ø·Ø§Ù„Ø¨
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ù‡Ø¯ÙÙ‡ Ø®Ù„Ø§Ù„ 3 Ø´Ù‡ÙˆØ±</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[80px]"
                                            onblur="updateField('${id}', 'goal3months', this.value)">${a.goal3months || ''}</textarea>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ù‡Ø¯ÙÙ‡ Ø®Ù„Ø§Ù„ 6 Ø´Ù‡ÙˆØ±</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[80px]"
                                            onblur="updateField('${id}', 'goal6months', this.value)">${a.goal6months || ''}</textarea>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <span class="text-[10px] font-black text-gray-400">Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ù„Ù… (Ø´ØºÙ„ / ÙØ±ÙŠÙ„Ø§Ù†Ø³ / ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§Øª)</span>
                                    <input type="text" value="${a.learningReason || ''}" 
                                        class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                        onblur="updateField('${id}', 'learningReason', this.value)">
                                </div>
                            </div>

                            <!-- Learning Path Section -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">map</span>
                                    ğŸ—ºï¸ Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù… (Learning Path)
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±</span>
                                        <input type="text" value="${a.pathName || a.specialization || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'pathName', this.value)">
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</span>
                                        <input type="number" value="${a.totalWeeks || 0}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'totalWeeks', this.value)">
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                                        <input type="number" value="${a.currentWeek || 1}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'currentWeek', this.value)">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ù„Ù…ØµØ§Ø¯Ø± (YouTube / Docs)</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[60px]"
                                            onblur="updateField('${id}', 'resources', this.value)">${a.resources || ''}</textarea>
                                    </div>
                                    <div class="space-y-1">
                                        <span class="text-[10px] font-black text-gray-400">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</span>
                                        <textarea class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[60px]"
                                            onblur="updateField('${id}', 'requiredTasks', this.value)">${a.requiredTasks || ''}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress & Evaluation -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                        <span class="material-symbols-outlined text-primary">analytics</span>
                                        ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-[10px] font-black text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (%)</span>
                                            <span class="text-xs font-black text-primary">${a.progressPercent || 0}%</span>
                                        </div>
                                        <input type="range" value="${a.progressPercent || 0}" min="0" max="100" class="w-full accent-primary" 
                                            oninput="this.previousElementSibling.querySelector('span:last-child').innerText = this.value + '%'"
                                            onchange="updateField('${id}', 'progressPercent', this.value)">
                                        <input type="text" placeholder="Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ ØªÙ… Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡" value="${a.lastVideo || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'lastVideo', this.value)">
                                        <input type="text" placeholder="Ø¢Ø®Ø± Ù…Ù‡Ù…Ø© ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡Ø§" value="${a.lastTask || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'lastTask', this.value)">
                                        <select class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onchange="updateField('${id}', 'understandingLevel', this.value)">
                                            <option value="" disabled ${!a.understandingLevel ? 'selected' : ''}>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙÙ‡Ù…</option>
                                            <option value="Ø¶Ø¹ÙŠÙ" ${a.understandingLevel === 'Ø¶Ø¹ÙŠÙ' ? 'selected' : ''}>Ø¶Ø¹ÙŠÙ</option>
                                            <option value="Ù…ØªÙˆØ³Ø·" ${a.understandingLevel === 'Ù…ØªÙˆØ³Ø·' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·</option>
                                            <option value="Ù…Ù…ØªØ§Ø²" ${a.understandingLevel === 'Ù…Ù…ØªØ§Ø²' ? 'selected' : ''}>Ù…Ù…ØªØ§Ø²</option>
                                        </select>
                                        <input type="text" placeholder="Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø£Ùˆ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹" value="${a.absenceDays || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'absenceDays', this.value)">
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                        <span class="material-symbols-outlined text-primary">biotech</span>
                                        ğŸ§ª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                                    </h3>
                                    <div class="space-y-3">
                                        <input type="text" placeholder="Ù†ØªÙŠØ¬Ø© ÙƒÙ„ Quiz" value="${a.quizResults || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'quizResults', this.value)">
                                        <input type="text" placeholder="ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" value="${a.projectEvaluation || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'projectEvaluation', this.value)">
                                        <textarea placeholder="Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[50px]"
                                            onblur="updateField('${id}', 'strengths', this.value)">${a.strengths || ''}</textarea>
                                        <textarea placeholder="Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[50px]"
                                            onblur="updateField('${id}', 'weaknesses', this.value)">${a.weaknesses || ''}</textarea>
                                        <textarea placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„ØªÙ‚Ù†ÙŠØ©" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[50px]"
                                            onblur="updateField('${id}', 'techNotes', this.value)">${a.techNotes || ''}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Communication & Engagement -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                        <span class="material-symbols-outlined text-primary">forum</span>
                                        ğŸ’¬ Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="space-y-1">
                                            <span class="text-[10px] font-black text-gray-400">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù…ØªØ§Ø¨Ø¹Ø©</span>
                                            <input type="text" value="${a.lastFollowUpDate || ''}" 
                                                class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                                onblur="updateField('${id}', 'lastFollowUpDate', this.value)">
                                        </div>
                                        <textarea placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[60px]"
                                            onblur="updateField('${id}', 'callNotes', this.value)">${a.callNotes || ''}</textarea>
                                        <textarea placeholder="Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[60px]"
                                            onblur="updateField('${id}', 'faq', this.value)">${a.faq || ''}</textarea>
                                        <textarea placeholder="Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ù‚Ø§Ø¨Ù„Ù‡Ø§" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-3 text-xs font-bold focus:ring-primary min-h-[60px]"
                                            onblur="updateField('${id}', 'problemsEncountered', this.value)">${a.problemsEncountered || ''}</textarea>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                        <span class="material-symbols-outlined text-primary">star</span>
                                        â­ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-[10px] font-black text-gray-400">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ© (1â€“5 â­)</span>
                                            <div class="flex gap-1">
                                                ${[1, 2, 3, 4, 5].map(star => `
                                                    <button onclick="updateField('${id}', 'seriousnessLevel', ${star}); this.parentElement.querySelectorAll('span').forEach((s,i) => s.textContent = i < ${star} ? 'star' : 'star_outline')" 
                                                        class="text-orange-400">
                                                        <span class="material-symbols-outlined text-lg">${(a.seriousnessLevel || 0) >= star ? 'star' : 'star_outline'}</span>
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <input type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©" value="${a.lateTasksCount || 0}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'lateTasksCount', this.value)">
                                        <input type="text" placeholder="Ø§Ù„ØªÙØ§Ø¹Ù„ ÙÙŠ Discord" value="${a.discordEngagement || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'discordEngagement', this.value)">
                                        <input type="text" placeholder="Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª" value="${a.attendanceLevel || ''}" 
                                            class="w-full h-11 bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-xl px-4 text-xs font-bold"
                                            onblur="updateField('${id}', 'attendanceLevel', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- General Notes -->
                            <div class="space-y-4">
                                <h3 class="flex items-center gap-2 text-base font-black text-secondary dark:text-white border-b-2 border-primary/20 pb-2">
                                    <span class="material-symbols-outlined text-primary">notes</span>
                                    ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <textarea placeholder="Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³ÙŠØ³ØªÙ…" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-4 text-xs font-bold focus:ring-primary min-h-[100px]"
                                        onblur="updateField('${id}', 'extraNotes', this.value)">${a.extraNotes || ''}</textarea>
                                    <textarea placeholder="Ø¸Ø±ÙˆÙ Ø§Ù„Ø·Ø§Ù„Ø¨" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-4 text-xs font-bold focus:ring-primary min-h-[100px]"
                                        onblur="updateField('${id}', 'studentContext', this.value)">${a.studentContext || ''}</textarea>
                                </div>
                                <textarea placeholder="Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù‡" class="w-full bg-gray-50 dark:bg-[#151e22] border-gray-100 dark:border-gray-800 rounded-2xl p-4 text-xs font-bold focus:ring-primary min-h-[80px]"
                                    onblur="updateField('${id}', 'suggestions', this.value)">${a.suggestions || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="pdf-ignore" class="flex flex-wrap gap-3 pt-6 border-t border-gray-100 dark:border-gray-800">
                        <button onclick="renewSubscription('${id}')" class="px-6 py-3 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">autorenew</span>
                            ØªØ¬Ø¯ÙŠØ¯ (30 ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯Ø©)
                        </button>
                        <button onclick="sendQuickMsg('${a.phone}', 'welcome', '${a.name}')" class="px-6 py-3 bg-green-50 text-green-600 hover:bg-green-600 hover:text-white rounded-xl font-bold text-xs transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">verified</span>
                            Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ÙˆÙ‚Ø¨ÙˆÙ„
                        </button>
                        <button onclick="downloadProfilePDF('${id}', '${a.name}')" class="px-6 py-3 bg-red-100 text-red-600 hover:bg-red-600 hover:text-white rounded-xl font-black text-xs transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">picture_as_pdf</span>
                            ØªØ­Ù…ÙŠÙ„ PDF
                        </button>
                    </div>
                `;

                    document.getElementById('modalActionContainer').innerHTML = `
                    <a href="https://wa.me/${formatWhatsAppPhone(a.phone)}" target="_blank" class="px-8 py-3 bg-green-500 hover:bg-green-600 text-white font-black rounded-2xl transition-all shadow-xl shadow-green-500/20 flex items-center gap-2">
                        <span class="material-symbols-outlined">chat</span>
                        ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨
                    </a>
                `;

                    document.getElementById('applicantModal').classList.remove('hidden');

                    // Populate teacher assignment dropdown
                    const tSnap = await databases.listDocuments(DATABASE_ID, COLLECTIONS.ADMINS, [Query.equal("role", "teacher")]);
                    const select = document.getElementById('teacherAssignmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>' +
                            tSnap.documents.map(tDoc => `<option value="${tDoc.$id}" ${a.teacherId === tDoc.$id ? 'selected' : ''}>${tDoc.username}</option>`).join('');
                    }
                } catch (e) { console.error(e); }
            }

            async function downloadProfilePDF(id, name) {
                const element = document.getElementById('applicantDetails');
                const opt = {
                    margin: [10, 10],
                    filename: `Ø¨Ø±ÙˆÙÙŠÙ„_${name}_Ø¨ÙˆØµÙ„Ø©.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Temporary styles to make things look perfect in PDF
                const pdfIgnore = document.getElementById('pdf-ignore');
                const originalStyle = element.getAttribute('style') || '';

                // Apply PDF-specific styling
                element.style.padding = '30px';
                element.style.backgroundColor = '#ffffff';
                element.style.direction = 'rtl';

                if (pdfIgnore) pdfIgnore.style.display = 'none';

                try {
                    // Ensure all fonts and styles are loaded
                    await html2pdf().set(opt).from(element).save();
                } catch (err) {
                    console.error('PDF Generation Error:', err);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ PDF');
                } finally {
                    // Restore UI
                    if (pdfIgnore) pdfIgnore.style.display = 'flex';
                    element.setAttribute('style', originalStyle);
                }
            }

            function closeModal() {
                document.getElementById('applicantModal').classList.add('hidden');
            }

            async function deleteApplicant(id) {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id);
                    fetchApplicants();
                } catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); }
            }

            async function updateStatus(id, newStatus) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        status: newStatus
                    });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.status = newStatus;
                    renderApplicants(applicants);
                } catch (error) {
                    console.error("Error updating status: ", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + error.message);
                }
            }

            async function togglePayment(id, currentStatus) {
                const newStatus = currentStatus === 'paid' ? 'unpaid' : 'paid';
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, { paymentStatus: newStatus });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.paymentStatus = newStatus;
                    renderApplicants(applicants);
                } catch (error) { alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹"); }
            }

            async function saveNotes(id, notes) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, { notes: notes });
                    const app = applicants.find(a => a.id === id);
                    if (app) app.notes = notes;
                } catch (error) { console.error("Error saving notes", error); }
            }

            async function renewSubscription(id) {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„ØªØ¨Ø¯Ø£ 30 ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¢Ù†ØŸ')) return;
                try {
                    const now = new Date();
                    const expiry = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                    const startStr = now.toLocaleDateString('ar-EG');
                    const endStr = expiry.toLocaleDateString('ar-EG');

                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, id, {
                        timestamp: now.toISOString(),
                        paymentStatus: 'paid',
                        subscriptionStart: startStr,
                        subscriptionEnd: endStr
                    });

                    const app = applicants.find(a => a.id === id);
                    if (app) {
                        app.subscriptionStart = startStr;
                        app.subscriptionEnd = endStr;
                        app.paymentStatus = 'paid';
                    }

                    alert('ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!');
                    closeModal();
                    fetchApplicants();
                } catch (error) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯"); }
            }

            function sendQuickMsg(phone, type, name) {
                let msg = "";
                if (type === 'welcome') {
                    msg = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}! %0AÙ„Ù‚Ø¯ ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØµÙ„Ø© ÙˆÙ‚Ø¨ÙˆÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†ÙƒÙˆÙ† Ù…Ø¹Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© ÙÙŠ Ù…Ø³Ø§Ø±Ùƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ.`;
                } else if (type === 'expiry') {
                    msg = `Ø¹Ø²ÙŠØ²ÙŠ ${name},%0A Ù†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø£Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø¨ÙˆØµÙ„Ø© Ø³ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.`;
                }
                window.open(`https://wa.me/${formatWhatsAppPhone(phone)}?text=${msg}`, '_blank');
            }

            // Theme Logic synced from head or previous session handled by head script
            async function deleteAllApplicants() {
                if (!confirm('!!! ØªØ­Ø°ÙŠØ± Ø´Ø¯ÙŠØ¯ !!!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;

                const password = prompt('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø­Ø°Ù) Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±:');
                if (password !== 'Ø­Ø°Ù') {
                    alert('ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.');
                    return;
                }

                const deleteAllBtn = document.getElementById('deleteAllBtn');
                const originalContent = deleteAllBtn.innerHTML;

                try {
                    deleteAllBtn.disabled = true;
                    deleteAllBtn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

                    // Appwrite doesn't have batch delete, so we do it in parallel
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.APPLICANTS, [Query.limit(100)]);
                    await Promise.all(response.documents.map(doc => databases.deleteDocument(DATABASE_ID, COLLECTIONS.APPLICANTS, doc.$id)));

                    alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
                    fetchApplicants();
                } catch (error) {
                    console.error("Error deleting all applicants: ", error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø°Ù: ' + error.message);
                } finally {
                    deleteAllBtn.disabled = false;
                    deleteAllBtn.innerHTML = originalContent;
                }
            }

            document.getElementById('deleteAllBtn').onclick = deleteAllApplicants;

            function exportToExcel() {
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„ØªØ®ØµØµ", "Ø§Ù„Ø¨Ø§Ù‚Ø©", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¹Ù…Ø§Ù„", "Ù„Ù…Ø§Ø°Ø§ ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…"]
                ];
                applicants.forEach(applicant => {
                    ws_data.push([
                        applicant.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.specialization || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.plan || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        applicant.portfolio || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.bio || 'ØºÙŠØ± Ù…ØªÙˆÙØ±',
                        applicant.timestamp ? new Date(applicant.timestamp.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†");
                XLSX.writeFile(wb, "elbosla-applicants.xlsx");
            }

            document.getElementById('exportBtn').onclick = exportToExcel;
            document.getElementById('resetSearchBtn').onclick = () => {
                searchInput.value = '';
                specializationFilter.value = '';
                document.getElementById('planFilter').value = '';
                document.getElementById('paymentFilter').value = '';
                filter();
            };

            specializationFilter.onchange = filter;
            document.getElementById('planFilter').onchange = filter;
            document.getElementById('paymentFilter').onchange = filter;
            searchInput.oninput = filter;
            document.getElementById('consultationSearchInput').oninput = renderConsultations;
            document.getElementById('exportConsultationsBtn').onclick = exportConsultationsToExcel;

            function filter() {
                const term = searchInput.value.toLowerCase();
                const spec = specializationFilter.value;
                const plan = document.getElementById('planFilter').value;
                const payment = document.getElementById('paymentFilter').value;

                // Separate Free Consultations from regular students
                const regularStudents = applicants.filter(a => a.plan !== 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©');

                let filtered = regularStudents.filter(a => {
                    const matchTerm = (a.name || '').toLowerCase().includes(term) || (a.specialization || '').toLowerCase().includes(term) || (a.phone || '').includes(term);
                    const matchSpec = !spec || a.specialization === spec;
                    const matchPlan = !plan || a.plan === plan;
                    const matchPayment = !payment || (payment === 'paid' ? a.paymentStatus === 'paid' : a.paymentStatus !== 'paid');
                    return matchTerm && matchSpec && matchPlan && matchPayment;
                });

                // Update Dashboard Stats for Students section
                document.getElementById('activeCountStats').textContent = filtered.filter(a => a.status === 'Ù†Ø´Ø·').length;

                // Calc expiring
                const expiring = filtered.filter(a => {
                    if (!a.timestamp) return false;
                    const date = new Date(a.timestamp);
                    const expiryDate = new Date(date.getTime() + (30 * 24 * 60 * 60 * 1000));
                    const diff = (expiryDate - new Date()) / (1000 * 60 * 60 * 24);
                    return diff > 0 && diff < 5;
                }).length;
                document.getElementById('expiringCountStats').textContent = expiring;

                renderApplicants(filtered);
            }

            if (userRole === 'teacher') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                // Auto switch done by HTML 'active' class on section-applicants
            } else {
                fetchApplicants();
            }

            // --- Mobile Sidebar Toggle ---
            function toggleChatSidebar() {
                const sidebar = document.getElementById('chatSidebar');
                const overlay = document.getElementById('chatOverlay');
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
            }

            // --- Chat Logic ---
            let activeChatId = null;
            let messagesUnsubscribe = null;

            function updateChatList() {
                const list = document.getElementById('chatList');
                const loggedInUserId = sessionStorage.getItem('user_doc_id'); // We'll need to set this on login

                // Filter applicants who have passwords (active students) or show all
                let activeStudents = applicants.filter(a => a.status === 'Ù†Ø´Ø·');

                // If teacher, restriction:
                if (userRole === 'teacher') {
                    activeStudents = activeStudents.filter(s => s.teacherId === loggedInUserId);
                }

                if (activeStudents.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 opacity-30 text-xs font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                    return;
                }

                list.innerHTML = activeStudents.map(student => `
                    <button onclick="selectChat('${student.id}', '${student.name}')" 
                        class="w-full flex items-center gap-3 p-3 rounded-2xl transition-all hover:bg-primary/5 group ${activeChatId === student.id ? 'bg-primary/10' : ''}">
                        <div class="size-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center text-primary group-hover:scale-110 transition-transform">
                            <span class="material-symbols-outlined text-xl">person</span>
                        </div>
                        <div class="text-right overflow-hidden">
                            <p class="font-black text-sm text-secondary dark:text-white truncate">${student.name}</p>
                            <p class="text-[9px] font-bold text-gray-400 truncate">${student.specialization || 'Ø·Ø§Ù„Ø¨'}</p>
                        </div>
                    </button>
                `).join('');
            }


            function selectChat(studentId, studentName) {
                activeChatId = studentId;
                document.getElementById('activeChatTitle').textContent = studentName;
                document.getElementById('activeChatIcon').textContent = 'person';
                document.getElementById('meetingBtn').classList.remove('hidden');
                updateChatList();
                loadMessages(studentId);

                // On mobile, close sidebar after selection
                if (window.innerWidth < 1024) {
                    toggleChatSidebar();
                }
            }

            function loadMessages(studentId) {
                if (messagesUnsubscribe) messagesUnsubscribe();
                const chatMessages = document.getElementById('chatMessages');

                // Initial load
                databases.listDocuments(DATABASE_ID, COLLECTIONS.MESSAGES, [
                    Query.equal('senderId', studentId),
                    Query.orderAsc('timestamp')
                ]).then(response => {
                    renderMessagesUI(response.documents);
                });

                // Realtime subscription
                messagesUnsubscribe = client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTIONS.MESSAGES}.documents`, response => {
                    if (response.events.some(e => e.includes('.create'))) {
                        const m = response.payload;
                        if (m.senderId === studentId) {
                            // Fetch again or append locally
                            databases.listDocuments(DATABASE_ID, COLLECTIONS.MESSAGES, [
                                Query.equal('senderId', studentId),
                                Query.orderAsc('timestamp')
                            ]).then(res => renderMessagesUI(res.documents));
                        }
                    }
                });
            }

            function renderMessagesUI(docs) {
                const chatMessages = document.getElementById('chatMessages');
                if (docs.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-center opacity-20">
                            <span class="material-symbols-outlined text-6xl">waving_hand</span>
                            <p class="font-black mt-4">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${document.getElementById('activeChatTitle').textContent}</p>
                        </div>`;
                    return;
                }

                chatMessages.innerHTML = docs.map(m => {
                    const isAdmin = m.senderType === 'admin';

                    let content = `<p class="text-sm font-bold">${m.text || ''}</p>`;
                    if (m.type === 'audio') {
                        content = `<audio src="${m.audioUrl}" controls class="h-8 max-w-full"></audio>`;
                    } else if (m.type === 'meeting') {
                        content = `
                             <div class="bg-blue-600/10 dark:bg-blue-600/20 p-4 rounded-2xl border border-blue-600/20 text-center">
                                 <div class="flex items-center justify-center gap-2 mb-2">
                                     <img src="https://www.gstatic.com/images/branding/product/2x/meet_48dp.png" class="size-5" alt="Google Meet">
                                     <p class="text-[10px] font-black text-blue-600 dark:text-blue-400">Ø§Ø¬ØªÙ…Ø§Ø¹ Google Meet</p>
                                 </div>
                                 <a href="${m.meetingUrl}" target="_blank" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-[10px] font-black inline-block shadow-lg shadow-blue-600/20 transition-all hover:scale-105">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</a>
                             </div>`;
                    } else if (m.type === 'file') {
                        const isImage = m.fileType && m.fileType.startsWith('image/');
                        if (isImage) {
                            content = `<a href="${m.fileUrl}" target="_blank"><img src="${m.fileUrl}" class="rounded-xl max-w-full max-h-60 object-cover shadow-sm" alt="image"></a>`;
                        } else {
                            content = `
                                <a href="${m.fileUrl}" target="_blank" class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all text-secondary dark:text-white">
                                    <span class="material-symbols-outlined text-primary">description</span>
                                    <div class="text-right overflow-hidden">
                                        <p class="text-[10px] font-black truncate max-w-[150px]">${m.fileName || 'Ù…Ù„Ù Ù…Ø±ÙÙ‚'}</p>
                                        <p class="text-[8px] opacity-60">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</p>
                                    </div>
                                </a>`;
                        }
                    }

                    const deleteBtn = (isAdmin && userRole === 'admin') ? `
                        <button onclick="deleteChatMessage('${m.$id}', '${m.fileUrl}')" class="text-red-400 hover:text-red-600 transition-colors mt-1">
                            <span class="material-symbols-outlined text-xs">delete</span>
                        </button>
                    ` : '';

                    return `
                        <div class="flex ${isAdmin ? 'justify-start' : 'justify-end'}">
                            <div class="max-w-[80%] p-4 rounded-2xl shadow-sm border ${isAdmin
                            ? 'bg-primary text-white border-primary rounded-tr-none'
                            : 'bg-white dark:bg-gray-800 text-secondary dark:text-white border-gray-100 dark:border-gray-700 rounded-tl-none'}">
                                ${content}
                                <div class="flex justify-between items-end gap-4">
                                    ${deleteBtn}
                                    <p class="text-[8px] mt-1 opacity-60 text-left" dir="ltr">${m.timestamp ? new Date(m.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : ''}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // --- Voice Recording Logic ---
            let mediaRecorder;
            let audioChunks = [];
            let recordInterval;

            document.getElementById('voiceBtn').onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                    mediaRecorder.onstop = uploadVoice;

                    mediaRecorder.start();
                    showRecordingUI();
                } catch (err) {
                    alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
                }
            };

            function showRecordingUI() {
                document.getElementById('chatForm').classList.add('hidden');
                document.getElementById('recordingStatus').classList.remove('hidden');
                let sec = 0;
                recordInterval = setInterval(() => {
                    sec++;
                    let m = Math.floor(sec / 60).toString().padStart(2, '0');
                    let s = (sec % 60).toString().padStart(2, '0');
                    document.getElementById('recordTimer').textContent = `${m}:${s} `;
                }, 1000);
            }

            function cancelRecording() {
                mediaRecorder.stop();
                mediaRecorder.onstop = null;
                hideRecordingUI();
            }

            function stopAndSendRecording() {
                mediaRecorder.stop();
                hideRecordingUI();
            }

            function hideRecordingUI() {
                document.getElementById('chatForm').classList.remove('hidden');
                document.getElementById('recordingStatus').classList.add('hidden');
                clearInterval(recordInterval);
                document.getElementById('recordTimer').textContent = "00:00";
            }

            async function uploadVoice() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const file = new File([audioBlob], `voice_${Date.now()}.webm`, { type: audioBlob.type });

                try {
                    const response = await storage.createFile('chats', ID.unique(), file);
                    const url = storage.getFileDownload('chats', response.$id);
                    await sendMsg({
                        type: 'audio',
                        audioUrl: url,
                        fileId: response.$id
                    });
                    if (activeChatId) loadMessages(activeChatId);
                } catch (err) {
                    console.error("Audio upload failed", err);
                }
                stopRecordingUI();
            }

            async function handleFileUpload(files) {
                if (!files || files.length === 0 || !activeChatId) return;

                for (let file of files) {
                    try {
                        const response = await storage.createFile('chats', ID.unique(), file);
                        const url = storage.getFileDownload('chats', response.$id);
                        await sendMsg({
                            type: 'file',
                            fileUrl: url,
                            fileName: file.name,
                            fileType: file.type,
                            fileId: response.$id
                        });
                        if (activeChatId) loadMessages(activeChatId);
                    } catch (err) {
                        console.error("Upload failed", err);
                        alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: " + file.name);
                    }
                }
                document.getElementById('fileInput').value = '';
            }

            async function deleteChatMessage(msgId, fileUrl) {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')) return;
                try {
                    // 1. Delete message from Appwrite
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.MESSAGES, msgId);

                    // 2. Delete from Storage (optional but good practice)
                    if (fileUrl) {
                        try {
                            // Extract fileId from URL if possible, or store it in message
                            // Assuming URL contains fileId
                            const fileId = fileUrl.split('/').pop().split('?')[0];
                            await storage.deleteFile('chats', fileId);
                        } catch (e) {
                            console.warn("Could not delete from storage", e);
                        }
                    }
                    if (activeChatId) loadMessages(activeChatId);
                } catch (err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message);
                }
            }

            async function sendMsg(data) {
                if (!activeChatId) return;
                const msg = {
                    ...data,
                    senderType: 'admin',
                    senderId: 'admin',
                    timestamp: new Date().toISOString()
                };
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.MESSAGES, ID.unique(), msg);
                } catch (err) {
                    console.error("Error sending message:", err);
                }
            }

            async function startMeeting() {
                const url = prompt("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¬ÙˆØ¬Ù„ Ù…ÙŠØª (Google Meet):", "https://meet.google.com/");
                if (!url) return;

                if (!url.includes("meet.google.com") && !url.includes("http")) {
                    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­");
                    return;
                }

                await sendMsg({
                    type: 'meeting',
                    meetingUrl: url,
                    text: 'ØªÙ… Ø¨Ø¯Ø¡ Ø§Ø¬ØªÙ…Ø§Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Google Meet. ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¢Ù† Ù„Ù…Ù†Ø§Ù‚Ø´Ø© Ø£Ø³Ø¦Ù„ØªÙƒ.'
                });
            }

            document.getElementById('chatForm').onsubmit = async (e) => {
                e.preventDefault();
                const input = document.getElementById('chatInput');
                const text = input.value.trim();

                if (!text || !activeChatId) return;

                const msg = {
                    text: text,
                    senderType: 'admin',
                    senderId: 'admin', // or actual admin id
                    timestamp: new Date().toISOString()
                };

                input.value = '';
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.MESSAGES, ID.unique(), msg);
                    loadMessages(activeChatId);
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
                }
            };

            let deviceChart = null, activityChart = null, clickChart = null, sectionChart = null;

            async function fetchVisitStats() {
                const tableBody = document.getElementById('visitsTableBody');
                if (!tableBody) return;

                const timeFilter = document.getElementById('statsTimeFilter')?.value || 'all';
                const deviceFilter = document.getElementById('statsDeviceFilter')?.value || 'all';
                const platformFilter = document.getElementById('statsPlatformFilter')?.value || 'all';

                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-20 opacity-30 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>`;

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.PAGE_VISITS, [
                        Query.orderDesc('timestamp'),
                        Query.limit(500)
                    ]);

                    let filteredDocs = response.documents.map(doc => ({ id: doc.$id, ...doc }));

                    // Client-side filtering
                    const now = new Date();
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    const startOfYesterday = startOfDay - (24 * 60 * 60 * 1000);
                    const startOfWeek = startOfDay - (7 * 24 * 60 * 60 * 1000);

                    filteredDocs = filteredDocs.filter(data => {
                        const timeObj = data.timestamp ? new Date(data.timestamp) : null;
                        const timeMs = timeObj ? timeObj.getTime() : 0;

                        // Time Filter
                        if (timeFilter === 'today' && timeMs < startOfDay) return false;
                        if (timeFilter === 'yesterday' && (timeMs < startOfYesterday || timeMs >= startOfDay)) return false;
                        if (timeFilter === 'week' && timeMs < startOfWeek) return false;

                        // Device Filter
                        if (deviceFilter !== 'all' && data.device !== deviceFilter) return false;

                        // Platform Filter
                        if (platformFilter !== 'all') {
                            const ref = (data.referrerSource || 'Direct').toLowerCase();
                            if (platformFilter === 'Direct') {
                                if (ref !== 'direct') return false;
                            } else {
                                if (!ref.includes(platformFilter)) return false;
                            }
                        }

                        return true;
                    });

                    let total = filteredDocs.length;
                    let desktop = 0, mobile = 0, tablet = 0;
                    let totalDuration = 0, totalScroll = 0, totalClicks = 0, totalConversions = 0;

                    const activityData = {};
                    const last7Days = [...Array(7)].map((_, i) => {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        return d.toLocaleDateString('ar-EG', { weekday: 'long' });
                    }).reverse();
                    last7Days.forEach(day => activityData[day] = 0);

                    const clickCounts = {};
                    const sectionViews = {};

                    const html = filteredDocs.map(data => {
                        // Metrics
                        if (data.device === 'Desktop') desktop++;
                        else if (data.device === 'Mobile') mobile++;
                        else if (data.device === 'Tablet') tablet++;

                        const dur = data.duration || 0;
                        totalDuration += dur;
                        totalScroll += (data.maxScroll || 0);

                        // events is likely a JSON string or array in Appwrite
                        const events = typeof data.events === 'string' ? JSON.parse(data.events) : (data.events || []);
                        totalClicks += events.length;

                        // Conversion check
                        const converted = events.some(e =>
                            e.name === 'click' && (e.data.text.includes('Ø§Ø¨Ø¯Ø£') || e.data.text.includes('Ø³Ø¬Ù„'))
                        );
                        if (converted) totalConversions++;

                        // Aggregate clicks
                        events.forEach(e => {
                            if (e.name === 'click') {
                                const key = e.data.text || 'Unnamed Button';
                                clickCounts[key] = (clickCounts[key] || 0) + 1;
                            }
                        });

                        // Aggregate sections
                        const viewedSections = typeof data.viewedSections === 'string' ? JSON.parse(data.viewedSections) : (data.viewedSections || []);
                        viewedSections.forEach(s => {
                            sectionViews[s] = (sectionViews[s] || 0) + 1;
                        });

                        const timeObj = data.timestamp ? new Date(data.timestamp) : null;
                        if (timeObj) {
                            const dayName = timeObj.toLocaleDateString('ar-EG', { weekday: 'long' });
                            if (activityData.hasOwnProperty(dayName)) activityData[dayName]++;
                        }

                        const timeStr = timeObj ? timeObj.toLocaleString('ar-EG', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'ØŸ';
                        const browser = data.userAgent ? (data.userAgent.includes('Chrome') ? 'Chrome' : (data.userAgent.includes('Firefox') ? 'Firefox' : 'Other')) : 'ØŸ';
                        const refSource = data.referrerSource || 'Direct';
                        const location = data.location || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

                        return `
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/50 transition-colors">
                                <td class="px-8 py-5 border-b border-gray-50 dark:border-gray-800/50">
                                    <p class="text-sm font-bold text-secondary dark:text-white">${timeStr}</p>
                                    <p class="text-[9px] text-gray-400 mt-0.5">${browser} â€¢ ${data.os || 'ØŸ'}</p>
                                </td>
                                <td class="px-8 py-5 border-b border-gray-50 dark:border-gray-800/50">
                                    <div class="flex items-center gap-3">
                                        <div class="size-8 rounded-lg flex items-center justify-center ${data.device === 'Mobile' ? 'bg-orange-500/10 text-orange-500' : 'bg-green-500/10 text-green-500'}">
                                            <span class="material-symbols-outlined text-sm">
                                                ${data.device === 'Mobile' ? 'smartphone' : 'desktop_windows'}
                                            </span>
                                        </div>
                                        <span class="text-xs font-black">${data.device}</span>
                                    </div>
                                </td>
                                <td class="px-8 py-5 border-b border-gray-50 dark:border-gray-800/50">
                                    <p class="text-[10px] font-black text-secondary dark:text-white">${location}</p>
                                    <p class="text-[9px] text-primary font-bold">${refSource}</p>
                                </td>
                                <td class="px-8 py-5 border-b border-gray-50 dark:border-gray-800/50">
                                    <div class="flex items-center gap-4">
                                        <div>
                                            <p class="text-xs font-black">${Math.floor(dur / 60)}:${(dur % 60).toString().padStart(2, '0')}</p>
                                            <p class="text-[9px] text-gray-400 font-bold">Ù…Ø¯Ø© Ø§Ù„Ø¨Ù‚Ø§Ø¡</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-black text-secondary dark:text-white">${data.maxScroll || 0}%</p>
                                            <p class="text-[9px] text-gray-400 font-bold">ØªØµÙØ­</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-8 py-5 border-b border-gray-50 dark:border-gray-800/50">
                                    <button onclick="deleteVisit('${data.id}')" 
                                        class="size-8 bg-red-100 text-red-500 hover:bg-red-500 hover:text-white rounded-lg flex items-center justify-center transition-all">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    tableBody.innerHTML = html || '<tr><td colspan="5" class="text-center py-20 opacity-30 font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø¨Ø­Ø«</td></tr>';

                    // Update Summaries
                    document.getElementById('totalVisitsCount').textContent = total;
                    document.getElementById('totalClicks').textContent = totalClicks;
                    document.getElementById('conversionRate').innerHTML = `<span class="material-symbols-outlined text-xs">ads_click</span> ${total > 0 ? Math.round((totalConversions / total) * 100) : 0}% Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„`;

                    const avgDurSec = total > 0 ? Math.round(totalDuration / total) : 0;
                    document.getElementById('avgDuration').textContent = `${Math.floor(avgDurSec / 60)}:${(avgDurSec % 60).toString().padStart(2, '0')}`;
                    document.getElementById('avgScroll').textContent = `${total > 0 ? Math.round(totalScroll / total) : 0}%`;

                    renderAdvancedCharts({ desktop, mobile, tablet }, activityData, last7Days, clickCounts, sectionViews);

                } catch (error) {
                    console.error("Error fetching visit stats:", error);
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-20 text-red-500 font-bold">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                }
            }

            async function deleteVisit(visitId) {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.PAGE_VISITS, visitId);
                    fetchVisitStats(); // Refresh table
                } catch (error) {
                    console.error("Error deleting visit:", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
                }
            }



            function renderAdvancedCharts(deviceCounts, activityData, days, clickCounts, sectionViews) {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#94a3b8' : '#263238';

                // Device Chart
                if (deviceChart) deviceChart.destroy();
                deviceChart = new Chart(document.getElementById('deviceChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Desktop', 'Mobile', 'Tablet'],
                        datasets: [{
                            data: [deviceCounts.desktop, deviceCounts.mobile, deviceCounts.tablet],
                            backgroundColor: ['#10b981', '#f59e0b', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
                });

                // Activity Chart
                if (activityChart) activityChart.destroy();
                activityChart = new Chart(document.getElementById('activityChart'), {
                    type: 'line',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª',
                            data: days.map(day => activityData[day]),
                            borderColor: '#13b6ec',
                            backgroundColor: 'rgba(19, 182, 236, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor } }, x: { ticks: { color: textColor } } } }
                });

                // Top Clicks Chart (Horizontal Bar)
                const clickLabels = Object.keys(clickCounts).slice(0, 5);
                const clickData = clickLabels.map(l => clickCounts[l]);
                if (clickChart) clickChart.destroy();
                clickChart = new Chart(document.getElementById('clickChart'), {
                    type: 'bar',
                    data: {
                        labels: clickLabels,
                        datasets: [{
                            data: clickData,
                            backgroundColor: '#13b6ec',
                            borderRadius: 10
                        }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { color: textColor } }, y: { ticks: { color: textColor } } } }
                });

                // Section Heatmap Chart
                const sectionLabels = Object.keys(sectionViews);
                const sectionData = sectionLabels.map(l => sectionViews[l]);
                if (sectionChart) sectionChart.destroy();
                sectionChart = new Chart(document.getElementById('sectionChart'), {
                    type: 'bar',
                    data: {
                        labels: sectionLabels,
                        datasets: [{
                            label: 'Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª',
                            data: sectionData,
                            backgroundColor: 'rgba(139, 92, 246, 0.6)',
                            borderRadius: 10
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor } }, x: { ticks: { color: textColor } } } }
                });
            }

            // --- CONTENT CALENDAR LOGIC (ENHANCED) ---
            let currentDate = new Date();
            let selectedDateStr = "";
            let contentStore = {};
            let uploadedImages = [];
            let currentDayTasks = [];
            let selectedPlatforms = [];

            async function initCalendar() {
                renderCalendar();
                fetchGlobalTasks();

                // Start a timer to refresh reminders every minute for the countdown
                if (window.reminderInterval) clearInterval(window.reminderInterval);
                window.reminderInterval = setInterval(renderReminders, 60000);
            }

            async function renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const monthYearLabel = document.getElementById('calendarMonthYear');
                if (!grid) return;

                grid.innerHTML = "";
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const monthName = currentDate.toLocaleDateString('ar-EG', { month: 'long' });
                monthYearLabel.innerText = `${monthName} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Saturday start adjustment
                let emptyStartingCells = (firstDayOfMonth + 1) % 7;

                await fetchMonthContent(year, month);
                renderReminders();

                for (let i = 0; i < emptyStartingCells; i++) {
                    grid.innerHTML += `<div class="bg-gray-50/30 dark:bg-gray-900/10 border-gray-100 dark:border-gray-700"></div>`;
                }

                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = dateStr === todayStr;
                    const content = contentStore[dateStr] || null;

                    let contentPreview = "";
                    if (content) {
                        const hasImages = content.images && content.images.length > 0;
                        const statusColor = content.status === 'published' ? 'bg-green-500' : (content.status === 'ready' ? 'bg-primary' : 'bg-gray-400');

                        // Icons for platforms
                        let platformIcons = (content.platforms || []).map(p => {
                            const iconMap = { facebook: 'fab fa-facebook-f', instagram: 'fab fa-instagram', linkedin: 'fab fa-linkedin-in', whatsapp: 'fab fa-whatsapp' };
                            return `<i class="${iconMap[p]} text-[8px] opacity-70"></i>`;
                        }).join(' ');

                        contentPreview = `
                            <div class="mt-1 space-y-0.5 w-full">
                                <div class="flex items-center justify-between">
                                    <div class="flex gap-1">${platformIcons}</div>
                                    <span class="size-1 rounded-full ${statusColor}"></span>
                                </div>
                                <p class="text-[8px] font-bold text-gray-500 truncate mt-0.5 line-clamp-1 leading-tight">${content.notes || '...'}</p>
                                ${content.publishTime ? `<div class="flex items-center gap-1 text-[7px] text-primary font-bold"><span class="material-symbols-outlined text-[7px]">schedule</span>${content.publishTime}</div>` : ''}
                                <div class="flex gap-0.5 mt-0.5">
                                    ${(content.dayTasks || []).map(t => `<span class="task-dot ${t.done ? 'done' : 'pending'}"></span>`).join('')}
                                </div>
                            </div>
                        `;
                    }

                    grid.innerHTML += `
                        <div onclick="openContentModal('${dateStr}')" class="p-2 cursor-pointer relative ${isToday ? 'bg-primary/5' : ''} border-gray-100 dark:border-gray-700 flex flex-col items-start hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <span class="day-num text-[9px] font-black ${isToday ? 'text-primary' : 'text-gray-400'}">${day}</span>
                            <div class="flex-1 w-full overflow-hidden">
                                ${contentPreview}
                            </div>
                        </div>
                    `;
                }
            }

            function changeMonth(dir) {
                currentDate.setMonth(currentDate.getMonth() + dir);
                renderCalendar();
            }

            async function fetchMonthContent(year, month) {
                contentStore = {};
                const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month + 1).padStart(2, '0')}-31`;

                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, [
                        Query.greaterThanEqual('date', startDate),
                        Query.lessThanEqual('date', endDate)
                    ]);

                    response.documents.forEach(doc => {
                        contentStore[doc.date] = { id: doc.$id, ...doc };
                    });
                } catch (e) {
                    console.error("Failed to fetch calendar content", e);
                }
            }

            // --- Modal Logic ---
            function openContentModal(dateStr) {
                selectedDateStr = dateStr;
                const d = new Date(dateStr);
                document.getElementById('modalDateDisplay').innerText = d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });

                const content = contentStore[dateStr] || { notes: "", images: [], platforms: [], publishTime: "", dayTasks: [], status: "draft" };

                // Handle Metadata stored in notes logic
                let userNotes = content.notes;
                let status = "draft";
                currentDayTasks = [];

                try {
                    // Try to parse notes as JSON metadata
                    if (content.notes && (content.notes.startsWith('{') || content.notes.startsWith('['))) {
                        const meta = JSON.parse(content.notes);
                        userNotes = meta.userNotes || "";
                        status = meta.status || "draft";
                        currentDayTasks = meta.dayTasks || [];
                    } else {
                        userNotes = content.notes || "";
                    }
                } catch (e) {
                    userNotes = content.notes || "";
                }

                // Fallback if dayTasks exists in root (for future migration support)
                if (content.dayTasks && typeof content.dayTasks === 'string') {
                    try { currentDayTasks = JSON.parse(content.dayTasks); } catch (e) { }
                }

                document.getElementById('contentNotes').value = userNotes;
                document.getElementById('contentStatus').value = status;

                // Parse time for display 2:30 PM
                const timeStr = content.publishTime || "12:00 AM";
                const [time, period] = timeStr.split(' ');
                const [h, m] = time.split(':');
                document.getElementById('publishHour').value = h || "12";
                document.getElementById('publishMinute').value = m || "00";
                document.getElementById('publishPeriod').value = period || "AM";
                document.getElementById('contentStatus').value = content.status || "draft";
                try {
                    uploadedImages = content.images ? JSON.parse(content.images) : [];
                } catch (e) {
                    uploadedImages = [];
                }
                try {
                    selectedPlatforms = content.platforms ? JSON.parse(content.platforms) : [];
                } catch (e) { selectedPlatforms = []; }
                currentDayTasks = content.dayTasks ? [...content.dayTasks] : [];

                updatePlatformUI();
                renderDayTasks();
                renderContentImages();

                if (content.id) {
                    document.getElementById('deleteContentBtn').classList.remove('hidden');
                } else {
                    document.getElementById('deleteContentBtn').classList.add('hidden');
                }

                document.getElementById('contentModal').classList.remove('hidden');
            }

            function closeContentModal() {
                document.getElementById('contentModal').classList.add('hidden');
            }

            function togglePlatform(p) {
                const idx = selectedPlatforms.indexOf(p);
                if (idx > -1) selectedPlatforms.splice(idx, 1);
                else selectedPlatforms.push(p);
                updatePlatformUI();
            }

            function updatePlatformUI() {
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    if (selectedPlatforms.includes(btn.dataset.platform)) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }

            function addDayTask() {
                const text = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©:");
                if (!text) return;
                currentDayTasks.push({ text, done: false });
                renderDayTasks();
            }

            function renderDayTasks() {
                const list = document.getElementById('dayTaskList');
                list.innerHTML = currentDayTasks.map((t, i) => `
                    <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-900 p-3 rounded-xl">
                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleDayTask(${i})" class="rounded text-primary focus:ring-primary size-4">
                        <span class="text-xs font-bold ${t.done ? 'line-through opacity-50' : 'text-secondary dark:text-white'}">${t.text}</span>
                        <button onclick="removeDayTask(${i})" class="mr-auto text-red-500 opacity-0 group-hover:opacity-100 transition-all"><span class="material-symbols-outlined text-sm">delete</span></button>
                    </div>
                `).join('');
            }

            function toggleDayTask(i) {
                currentDayTasks[i].done = !currentDayTasks[i].done;
                renderDayTasks();
            }

            function removeDayTask(i) {
                currentDayTasks.splice(i, 1);
                renderDayTasks();
            }

            function renderContentImages() {
                const grid = document.getElementById('contentImageGrid');
                const uploadLabel = grid.querySelector('label');
                grid.querySelectorAll('.img-preview').forEach(el => el.remove());
                uploadedImages.forEach((url, index) => {
                    const div = document.createElement('div');
                    div.className = "img-preview relative aspect-square rounded-2xl overflow-hidden shadow-md group border border-gray-100 dark:border-gray-700";
                    div.innerHTML = `<img src="${url}" class="w-full h-full object-cover">
                        <button onclick="removeContentImage(${index})" class="absolute top-1 right-1 size-6 bg-red-500 text-white rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                        <span class="material-symbols-outlined text-xs">close</span></button>`;
                    grid.insertBefore(div, uploadLabel);
                });
            }

            async function handleContentImages(files) {
                if (!files.length) return;
                const saveBtn = document.getElementById('saveContentBtn');
                saveBtn.disabled = true;
                for (let file of files) {
                    try {
                        const response = await storage.createFile('calendar', ID.unique(), file);
                        const url = storage.getFileDownload('calendar', response.$id);
                        uploadedImages.push(url);
                    } catch (e) { console.error(e); }
                }
                renderContentImages();
                saveBtn.disabled = false;
            }

            function removeContentImage(index) {
                uploadedImages.splice(index, 1);
                renderContentImages();
            }

            async function saveContent() {
                const saveBtn = document.getElementById('saveContentBtn');
                try {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

                    const timeStr = `${document.getElementById('publishHour').value}:${document.getElementById('publishMinute').value} ${document.getElementById('publishPeriod').value}`;

                    // Pack metadata into notes field because of attribute limits
                    const metadata = {
                        userNotes: document.getElementById('contentNotes').value,
                        status: document.getElementById('contentStatus').value,
                        dayTasks: currentDayTasks
                    };

                    const payload = {
                        date: selectedDateStr,
                        notes: JSON.stringify(metadata),
                        images: JSON.stringify(uploadedImages),
                        platforms: JSON.stringify(selectedPlatforms),
                        publishTime: timeStr,
                        updatedAt: new Date().toISOString()
                    };

                    const existingDoc = contentStore[selectedDateStr];
                    if (existingDoc) {
                        await databases.updateDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, existingDoc.id, payload);
                    } else {
                        await databases.createDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, ID.unique(), payload);
                    }

                    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­");
                    closeContentModal();
                    renderCalendar();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message); } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<span class="material-symbols-outlined text-sm">save</span> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                }
            }

            async function deleteContent() {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
                const existingDoc = contentStore[selectedDateStr];
                if (!existingDoc) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.CALENDAR_CONTENT, existingDoc.id);
                    closeContentModal();
                    renderCalendar();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); }
            }

            // --- Global Tasks Logic ---
            async function fetchGlobalTasks() {
                try {
                    const response = await databases.listDocuments(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, [
                        Query.orderDesc('createdAt')
                    ]);
                    const list = document.getElementById('globalTaskList');
                    let html = "";
                    response.documents.forEach(task => {
                        html += `
                            <div class="flex items-center gap-3 bg-gray-50/50 dark:bg-gray-900/30 p-4 rounded-2xl group border border-gray-50 dark:border-gray-800">
                                <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleGlobalTask('${task.$id}', ${task.done})" class="rounded text-primary focus:ring-primary">
                                <span class="text-xs font-bold flex-1 ${task.done ? 'line-through opacity-40' : 'text-secondary dark:text-white'}">${task.text}</span>
                                <button onclick="deleteGlobalTask('${task.$id}')" class="opacity-0 group-hover:opacity-100 text-red-400 transition-all"><span class="material-symbols-outlined text-xs">delete</span></button>
                            </div>
                        `;
                    });
                    list.innerHTML = html || '<div class="text-center py-10 opacity-30 text-xs font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ©</div>';
                } catch (e) { console.error(e); }
            }

            async function addGlobalTask() {
                const text = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                if (!text) return;
                try {
                    await databases.createDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, ID.unique(), {
                        text,
                        done: false,
                        createdAt: new Date().toISOString()
                    });
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); }
            }

            async function toggleGlobalTask(id, currentDone) {
                try {
                    await databases.updateDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, id, { done: !currentDone });
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
            }

            async function deleteGlobalTask(id) {
                if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
                try {
                    await databases.deleteDocument(DATABASE_ID, COLLECTIONS.GLOBAL_TASKS, id);
                    fetchGlobalTasks();
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); }
            }

            function renderReminders() {
                const reminderList = document.getElementById('upcomingReminders');
                if (!reminderList) return;

                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                const list = Object.values(contentStore)
                    .filter(c => {
                        const postDate = new Date(c.date);
                        postDate.setHours(23, 59, 59);
                        return postDate >= now && c.status !== 'published';
                    })
                    .sort((a, b) => {
                        // Custom sort for AM/PM format
                        const parseTime = (date, tStr) => {
                            const [time, period] = tStr.split(' ');
                            let [h, m] = time.split(':').map(Number);
                            if (period === 'PM' && h !== 12) h += 12;
                            if (period === 'AM' && h === 12) h = 0;
                            return new Date(`${date}T${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                        };
                        return parseTime(a.date, a.publishTime || '12:00 AM') - parseTime(b.date, b.publishTime || '12:00 AM');
                    })
                    .slice(0, 5);

                let html = "";
                list.forEach(c => {
                    const postDate = new Date(c.date);
                    const timeStrRaw = c.publishTime || '12:00 AM';
                    const [timePart, period] = timeStrRaw.split(' ');
                    let [h, m] = timePart.split(':').map(Number);
                    if (period === 'PM' && h !== 12) h += 12;
                    if (period === 'AM' && h === 12) h = 0;

                    const targetDateTime = new Date(`${c.date}T${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                    const diffMs = targetDateTime - now;

                    let countdownText = "";
                    if (diffMs > 0) {
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        if (diffHrs > 24) {
                            countdownText = `Ø¨Ø¹Ø¯ ${Math.floor(diffHrs / 24)} ÙŠÙˆÙ…`;
                        } else if (diffHrs > 0) {
                            countdownText = `Ø¨Ø§Ù‚ÙŠ ${diffHrs} Ø³Ø§Ø¹Ø© Ùˆ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        } else {
                            countdownText = `Ø¨Ø§Ù‚ÙŠ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
                        }
                    } else if (c.date === todayStr) {
                        countdownText = "Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±!";
                    }

                    // Platform Icons
                    let platformIcons = (c.platforms || []).map(p => {
                        const iconMap = { facebook: 'fab fa-facebook-f', instagram: 'fab fa-instagram', linkedin: 'fab fa-linkedin-in', whatsapp: 'fab fa-whatsapp' };
                        const colorMap = { facebook: '#1877f2', instagram: '#e1306c', linkedin: '#0077b5', whatsapp: '#25d366' };
                        return `<i class="${iconMap[p]} text-[10px]" style="color: ${colorMap[p]}"></i>`;
                    }).join(' ');

                    html += `
                        <div onclick="openContentModal('${c.date}')" class="group cursor-pointer bg-white dark:bg-gray-900/40 p-5 rounded-3xl border border-gray-100 dark:border-gray-800 hover:border-primary/30 hover:shadow-lg transition-all relative overflow-hidden">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="size-2 rounded-full ${c.status === 'ready' ? 'bg-primary animate-pulse' : 'bg-gray-300'}"></span>
                                    <span class="text-[10px] font-black text-secondary dark:text-white">${postDate.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' })}</span>
                                </div>
                                <div class="flex gap-1.5">${platformIcons}</div>
                            </div>
                            
                            <p class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-3 line-clamp-1">${c.notes || 'Ù…Ù†Ø´ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</p>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-gray-50 dark:border-gray-800/50">
                                <div class="flex items-center gap-1.5 text-primary">
                                    <span class="material-symbols-outlined text-sm">schedule</span>
                                    <span class="text-[10px] font-black">${c.publishTime || '--:--'}</span>
                                </div>
                                <span class="text-[9px] font-black text-gray-400 bg-gray-50 dark:bg-gray-800 px-2 py-1 rounded-lg">${countdownText}</span>
                            </div>
                        </div>
                    `;
                });
                reminderList.innerHTML = html || '<div class="text-center py-10 opacity-30 text-xs font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§</div>';
            }
        </script>
</body>

</html>